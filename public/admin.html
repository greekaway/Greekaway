<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Greekaway</title>
  <style>
  body {font-family: Arial, Helvetica, sans-serif; margin:20px; background-color: #eef7ff; }
    label{display:block;margin-top:8px}
    input[type=text], input[type=password]{width:300px;padding:6px}
    input[type=date], input[type=number]{padding:6px}
    .btn{margin-top:8px}
    .col{display:inline-block;vertical-align:top;width:48%;margin-right:2%}
  /* Excel-like table styling */
    #paymentsTable thead th{background:#f3f6fb;border:1px solid #cfd8e3}
    #paymentsTable tbody td{border:1px solid #e6edf5;padding:6px}
    #paymentsTable tbody tr:nth-child(even){background:#fbfcfe}
    #paymentsTable tbody tr:hover{background:#eef6ff}
  #paymentsTable td{text-align:left;font-family: Arial, Helvetica, sans-serif}
  /* Ensure panels remain white for contrast on the blue background */
  #main, .col, #paymentsContainer, #backup {background: #ffffff; padding: 10px; border-radius:6px}
    #paymentsTable td.amount{text-align:right;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
    .status-badge{display:inline-block;padding:4px 8px;border-radius:12px;color:white;font-weight:600;font-size:12px}
    .status-succeeded{background:#28a745}
    .status-failed{background:#dc3545}
    .status-processing{background:#17a2b8}
    .status-requires_payment_method{background:#ffc107;color:#212529}
    .status-canceled{background:#6c757d}
    .status-icon { margin-right:6px; }

    /* Modal for booking metadata */
    .modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal {background:#fff;border-radius:8px;padding:16px;max-width:800px;max-height:80vh;overflow:auto;box-shadow:0 6px 24px rgba(0,0,0,0.2)}
    .modal pre{white-space:pre-wrap;background:#f7f9fc;padding:8px;border-radius:6px}
    .sortable { cursor: pointer; text-decoration: underline dotted; }
    /* zebra for bookings too */
    #bookingsTable tbody tr:nth-child(even){background:#fbfcfe}
  </style>
</head>
<body>
  <div style="position:fixed;top:8px;right:12px;z-index:999">
    <select id="langSelect" aria-label="Language"></select>
  </div>
  <h2>Διαχείριση Greekaway</h2>
  <p data-i18n="admin.help">Βάλε τα διαπιστευτήρια διαχειριστή για να δεις τις πληρωμές και την κατάσταση αντιγράφων ασφαλείας.</p>
  <form id="auth">
    <label>User <input id="user" type="text" value="admin" /></label>
    <label>Pass <input id="pass" type="password" /></label>
    <button id="login">Login</button>
  </form>

  <div id="main" style="display:none">
    <div class="col">
  <h3 data-i18n="admin.backups">Κατάσταση αντιγράφων</h3>
  <button id="refreshBackup" data-i18n-value="admin.refresh">Ανανέωση</button>
  <div id="backup" style="margin-top:8px;color:#333;line-height:1.4"></div>
    </div>
    <div class="col">
  <h3>Πληρωμές (τελευταίες)</h3>
      <div id="filters" style="margin:12px auto 8px;max-width:1100px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;border-radius:6px;padding:8px">
          <label style="display:inline-block;margin-right:8px">Κατάσταση:
            <select id="filterStatus">
              <option value="">(any)</option>
              <option value="succeeded">succeeded</option>
              <option value="requires_payment_method">requires_payment_method</option>
              <option value="failed">failed</option>
              <option value="processing">processing</option>
              <option value="canceled">canceled</option>
            </select>
          </label>
          <label>Από: <input id="filterFrom" type="date" /></label>
          <label>Έως: <input id="filterTo" type="date" /></label>
          <label>Ελάχιστο (€): <input id="filterMin" type="number" step="0.01" placeholder="0.00" /></label>
          <label>Μέγιστο (€): <input id="filterMax" type="number" step="0.01" placeholder="" /></label>
          <button id="applyFilters" class="btn">Εφαρμογή</button>
          <button id="clearFilters" class="btn">Επαναφορά</button>
        </div>
        <div style="margin-bottom:8px">
          <button id="refreshPayments">Ανανέωση</button>
          <button id="exportPayments">Εξαγωγή σε CSV</button>
          <button id="copyExcel">Αντιγραφή στο Excel</button>
          <label style="margin-left:12px">Page size:
            <select id="pageSize"><option>50</option><option>100</option><option>200</option></select>
          </label>
          <button id="prevPage">Prev</button>
          <button id="nextPage">Next</button>
          <label style="margin-left:8px">Ταξινόμηση:
            <select id="sortField">
              <option value="">(none)</option>
              <option value="timestamp">timestamp</option>
              <option value="amount">amount</option>
              <option value="status">status</option>
            </select>
            <button id="sortDir" title="Toggle asc/desc">▲</button>
          </label>
          <span id="pageInfo" style="margin-left:8px">Σελίδα: 1</span>
        </div>
        <div id="paymentsContainer">
      <table id="paymentsTable" style="width:100%;border-collapse:collapse">
            <thead>
              <tr>
                <th style="border-bottom:1px solid #ddd;padding:6px;text-align:left">Κωδικός</th>
                <th style="border-bottom:1px solid #ddd;padding:6px;text-align:left">Κατάσταση</th>
                <th style="border-bottom:1px solid #ddd;padding:6px;text-align:left">Γεγονός</th>
                <th class="sortable" data-sort="amount" style="border-bottom:1px solid #ddd;padding:6px;text-align:right;width:140px">Ποσό (€)</th>
              <th style="border-bottom:1px solid #ddd;padding:6px;text-align:left">Νόμισμα</th>
            <th class="sortable" data-sort="timestamp" style="border-bottom:1px solid #ddd;padding:6px;text-align:left">Ημερομηνία</th>
                <th style="border-bottom:1px solid #ddd;padding:6px;text-align:left">Μεταδεδομένα</th>
              </tr>
            </thead>
            <tbody style="font-family:monospace;background:#fff"></tbody>
          </table>
          <div id="paymentsMessage" style="margin-top:8px;color:#666"></div>
        </div>
    </div>
  </div>
  <hr style="margin-top:16px" />
  <div id="bookingsPanel" style="display:none;margin-top:12px">
    <h3>Κρατήσεις</h3>
    <div style="margin-bottom:8px">
      <button id="refreshBookings">Ανανέωση Κρατήσεων</button>
      <button id="exportBookings">Εξαγωγή Κρατήσεων (CSV)</button>
    </div>
    <div id="bookingsContainer">
  <table id="bookingsTable" style="width:100%;border-collapse:collapse">
        <thead>
          <tr>
            <th style="border-bottom:1px solid #ddd;padding:6px;text-align:left">ID</th>
            <th style="border-bottom:1px solid #ddd;padding:6px;text-align:left">Κατάσταση</th>
            <th style="border-bottom:1px solid #ddd;padding:6px;text-align:left">PaymentIntent</th>
            <th style="border-bottom:1px solid #ddd;padding:6px;text-align:left">Γεγονός</th>
            <th style="border-bottom:1px solid #ddd;padding:6px;text-align:left">Όνομα</th>
            <th style="border-bottom:1px solid #ddd;padding:6px;text-align:left">Email</th>
            <th style="border-bottom:1px solid #ddd;padding:6px;text-align:left">Trip</th>
            <th style="border-bottom:1px solid #ddd;padding:6px;text-align:right">Seats</th>
            <th class="sortable" data-sort="price_cents" style="border-bottom:1px solid #ddd;padding:6px;text-align:right">Τιμή</th>
            <th class="sortable" data-sort="created_at" style="border-bottom:1px solid #ddd;padding:6px;text-align:left">Δημιουργήθηκε</th>
            <th style="border-bottom:1px solid #ddd;padding:6px;text-align:left">Metadata</th>
          </tr>
        </thead>
        <tbody style="font-family:monospace;background:#fff"></tbody>
      </table>
      <div id="bookingsMessage" style="margin-top:8px;color:#666"></div>
    </div>
  </div>

  <script>
    const authForm = document.getElementById('auth');
    const main = document.getElementById('main');
    const userInput = document.getElementById('user');
    const passInput = document.getElementById('pass');
  const backupPre = document.getElementById('backup');
  const backupDiv = document.getElementById('backup');
  const paymentsTbody = document.getElementById('paymentsTable').querySelector('tbody');
  const paymentsMessage = document.getElementById('paymentsMessage');

  let basicAuth = null;
  let lastPayments = null; // cached array from server
  let lastFiltered = null; // cached filtered view
  let currentOffset = 0;
  let currentLimit = 50;
  let currentSortField = '';
  let currentSortDir = 'desc'; // or 'asc'
  // separate bookings sort state so bookings and payments sorting don't interfere
  let bookingsSortField = '';
  let bookingsSortDir = 'desc';

    authForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const u = userInput.value || '';
      const p = passInput.value || '';
      basicAuth = 'Basic ' + btoa(u + ':' + p);
      main.style.display = 'block';
      authForm.style.display = 'none';
      fetchBackup();
      fetchPayments();
      // show bookings panel and load bookings
      document.getElementById('bookingsPanel').style.display = 'block';
      fetchBookings();
    });

    // Load filters from URL on page load
    (function loadFiltersFromUrl(){
      const params = new URLSearchParams(window.location.search);
      if (params.has('status')) document.getElementById('filterStatus').value = params.get('status');
      if (params.has('date_from')) document.getElementById('filterFrom').value = params.get('date_from');
      if (params.has('date_to')) document.getElementById('filterTo').value = params.get('date_to');
      if (params.has('min_amount')) document.getElementById('filterMin').value = (Number(params.get('min_amount'))/100).toFixed(2);
      if (params.has('max_amount')) document.getElementById('filterMax').value = (Number(params.get('max_amount'))/100).toFixed(2);
    })();

    document.getElementById('refreshBackup').addEventListener('click', fetchBackup);
  document.getElementById('refreshPayments').addEventListener('click', fetchPayments);
  document.getElementById('exportPayments').addEventListener('click', exportPayments);
  document.getElementById('applyFilters').addEventListener('click', applyFilters);
  document.getElementById('clearFilters').addEventListener('click', clearFilters);
    document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
    document.getElementById('nextPage').addEventListener('click', () => changePage(1));
    document.getElementById('pageSize').addEventListener('change', (e) => { currentLimit = parseInt(e.target.value,10) || 50; currentOffset = 0; fetchPayments(); });
    document.getElementById('sortField').addEventListener('change', (e) => { currentSortField = e.target.value || ''; applyFilters(); });
    document.getElementById('sortDir').addEventListener('click', (e) => { currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc'; e.target.textContent = currentSortDir === 'asc' ? '▼' : '▲'; applyFilters(); });

    function fetchBackup(){
      if(!basicAuth) return;
  backupPre.textContent = window.t ? window.t('admin.loading') : 'Loading...';
      fetch('/admin/backup-status', { headers: { Authorization: basicAuth } })
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(j => backupPre.textContent = JSON.stringify(j, null, 2))
  .catch(err => backupPre.textContent = (window.t ? window.t('admin.error') : 'Error: ') + String(err));
    }

    function pageInfo(){
      const page = Math.floor(currentOffset / currentLimit) + 1;
  document.getElementById('pageInfo').textContent = (window.t ? window.t('admin.page') : 'Page: ') + ' ' + page;
    }

    function changePage(dir){
      currentOffset = Math.max(0, currentOffset + dir * currentLimit);
      fetchPayments();
    }

    function fetchPayments(){
      if(!basicAuth) return;
      paymentsTbody.innerHTML = '';
  paymentsMessage.textContent = 'Φόρτωση...';
      const qs = `?limit=${encodeURIComponent(currentLimit)}&offset=${encodeURIComponent(currentOffset)}`;
  // append filters for payments as URL params and persist to location
  const params = new URLSearchParams();
  const status = document.getElementById('filterStatus').value;
  const from = document.getElementById('filterFrom').value;
  const to = document.getElementById('filterTo').value;
  const min = document.getElementById('filterMin').value;
  const max = document.getElementById('filterMax').value;
  if (status) params.set('status', status);
  if (from) params.set('date_from', from);
  if (to) params.set('date_to', to);
  if (min) params.set('min_amount', Math.round(Number(min)*100));
  if (max) params.set('max_amount', Math.round(Number(max)*100));
  // persist filters to URL
  const newUrl = window.location.pathname + '?' + params.toString();
  window.history.replaceState({}, '', newUrl);
  const url = '/admin/payments' + qs + (params.toString() ? '&' + params.toString() : '');
  fetch(url, { headers: { Authorization: basicAuth } })
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(j => {
          lastPayments = Array.isArray(j) ? j : [];
          // apply current filters automatically
          applyFilters();
          pageInfo();
        })
  .catch(err => { paymentsTbody.innerHTML = ''; paymentsMessage.textContent = (window.t ? window.t('admin.error') : 'Error: ') + String(err); });
    }

    function renderPayments(arr){
      lastFiltered = Array.isArray(arr) ? arr : [];
      // apply client-side sorting if requested
      let out = lastFiltered.slice();
      if (currentSortField) {
        out.sort((a,b) => {
          const fa = a && (currentSortField === 'amount' ? a.amount : a[currentSortField]);
          const fb = b && (currentSortField === 'amount' ? b.amount : b[currentSortField]);
          // handle timestamps
          if (currentSortField === 'timestamp') {
            const ta = fa ? new Date(fa).getTime() : 0;
            const tb = fb ? new Date(fb).getTime() : 0;
            return (ta - tb) * (currentSortDir === 'asc' ? 1 : -1);
          }
          if (currentSortField === 'amount') {
            const na = Number(fa) || 0;
            const nb = Number(fb) || 0;
            return (na - nb) * (currentSortDir === 'asc' ? 1 : -1);
          }
          // handle amount as number
          if (currentSortField === 'amount') {
            const na = Number(fa) || 0;
            const nb = Number(fb) || 0;
            return (na - nb) * (currentSortDir === 'asc' ? 1 : -1);
          }
          // fallback: string compare
          const sa = fa ? String(fa) : '';
          const sb = fb ? String(fb) : '';
          return sa.localeCompare(sb) * (currentSortDir === 'asc' ? 1 : -1);
        });
      }
      // render rows into table body
      paymentsTbody.innerHTML = '';
      if (!out || out.length === 0) {
        paymentsMessage.textContent = 'Δεν βρέθηκαν εγγραφές για αυτή τη σελίδα/φίλτρα.';
        return;
      }
      paymentsMessage.textContent = '';
      for (const row of out) {
        const tr = document.createElement('tr');
        const statusKey = (row.status || '').toString();
        const statusLabel = greekStatus(statusKey);
        const statusClass = statusClassFor(statusKey);
        const amountVal = formatAmount(row.amount, row.currency);
        const when = formatDate(row.timestamp);
        const statusIcon = statusIconFor(statusKey);
        tr.innerHTML = `
          <td>${escapeHtml(row.id||'')}</td>
          <td><span class="status-badge ${statusClass}"><span class="status-icon">${statusIcon}</span>${escapeHtml(statusLabel)}</span></td>
          <td>${escapeHtml(row.eventId||row.event_id||'')}</td>
          <td class="amount" style="text-align:right">${escapeHtml(amountVal)}</td>
          <td>${escapeHtml(row.currency||'')}</td>
          <td>${escapeHtml(when)}</td>
          <td>${escapeHtml(formatMeta(row.metadata||row.meta||''))} ${renderMetaButton(row.metadata||row.meta||'')}</td>
        `;
        paymentsTbody.appendChild(tr);
      }
    }

    // Add click handlers for sortable payment headers
    document.querySelectorAll('#paymentsTable thead th.sortable').forEach(th => {
      th.addEventListener('click', () => {
        const field = th.getAttribute('data-sort');
        if (currentSortField === field) currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
        else currentSortField = field;
        applyFilters();
      });
    });

    // Bookings UI logic
    const bookingsPanel = document.getElementById('bookingsPanel');
    const bookingsTbody = document.getElementById('bookingsTable').querySelector('tbody');
    const bookingsMessage = document.getElementById('bookingsMessage');

    document.getElementById('refreshBookings').addEventListener('click', fetchBookings);
    document.getElementById('exportBookings').addEventListener('click', exportBookings);

    async function fetchBookings(){
      if (!basicAuth) return;
      bookingsTbody.innerHTML = '';
      bookingsMessage.textContent = 'Φόρτωση...';
      try {
        const params = new URLSearchParams();
        params.set('limit', '1000');
        params.set('offset', '0');
        if (bookingsSortField) params.set('sort', bookingsSortField);
        if (bookingsSortDir) params.set('dir', bookingsSortDir);
        const qs = '?' + params.toString();
        const res = await fetch('/admin/bookings' + qs, { headers: { Authorization: basicAuth } });
        if (!res.ok) throw new Error(res.status);
        const arr = await res.json();
        renderBookings(arr || []);
      } catch (e) { bookingsTbody.innerHTML = ''; bookingsMessage.textContent = 'Error: ' + e; }
    }

    function renderBookings(arr){
      bookingsTbody.innerHTML = '';
      if (!arr || arr.length === 0) { bookingsMessage.textContent = 'No bookings found.'; return; }
      bookingsMessage.textContent = '';
      for (const b of arr) {
        const tr = document.createElement('tr');
        const when = formatDate(b.created_at);
        const price = formatAmount(b.price_cents || 0, 'eur');
        tr.innerHTML = `
          <td>${escapeHtml(b.id||'')}</td>
          <td>${escapeHtml(b.status||'')}</td>
          <td>${escapeHtml(b.payment_intent_id||'')}</td>
          <td>${escapeHtml(b.event_id||'')}</td>
          <td>${escapeHtml(b.user_name||'')}</td>
          <td>${escapeHtml(b.user_email||'')}</td>
          <td>${escapeHtml(b.trip_id||'')}</td>
          <td style="text-align:right">${escapeHtml(String(b.seats||''))}</td>
          <td style="text-align:right">${escapeHtml(price)}</td>
          <td>${escapeHtml(when)}</td>
          <td>${escapeHtml(typeof b.metadata === 'object' ? JSON.stringify(b.metadata) : (b.metadata||''))} ${renderBookingMetaButton(b.metadata||b.metadata||'', b.id, b.payment_intent_id)}</td>
        `;
        bookingsTbody.appendChild(tr);
      }
    }

    // Make bookings table headers sortable
    document.querySelectorAll('#bookingsTable thead th.sortable').forEach(th => {
      th.addEventListener('click', () => {
        const field = th.getAttribute('data-sort');
        if (bookingsSortField === field) bookingsSortDir = bookingsSortDir === 'asc' ? 'desc' : 'asc';
        else bookingsSortField = field;
        fetchBookings();
      });
    });

    async function exportBookings(){
      if (!basicAuth) return;
      const btn = document.getElementById('exportBookings'); btn.disabled = true; btn.textContent = 'Ετοιμάζεται...';
      try {
        const res = await fetch('/admin/bookings.csv', { headers: { Authorization: basicAuth } });
        if (!res.ok) throw new Error('Export failed: ' + res.status);
        const blob = await res.blob();
        const a = document.createElement('a');
        const url = URL.createObjectURL(blob);
        const cd = res.headers.get('Content-Disposition') || '';
        let filename = 'bookings.csv';
        const m = cd.match(/filename="?([^";]+)"?/);
        if (m && m[1]) filename = m[1];
        a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      } catch (e) { alert('Export failed: ' + e); }
      finally { btn.disabled = false; btn.textContent = 'Εξαγωγή Κρατήσεων (CSV)'; }
    }


    function greekStatus(s){
      if (!s) return '';
      const map = {
        'succeeded': 'Επιτυχής',
        'failed': 'Αποτυχημένη',
        'processing': 'Σε επεξεργασία',
        'requires_payment_method': 'Χρειάζεται μέθοδο',
        'canceled': 'Ακυρώθηκε'
      };
      return map[s] || s;
    }

    function statusClassFor(s){
      if (!s) return '';
      const map = {
        'succeeded': 'status-succeeded',
        'failed': 'status-failed',
        'processing': 'status-processing',
        'requires_payment_method': 'status-requires_payment_method',
        'canceled': 'status-canceled'
      };
      return map[s] || '';
    }

    function formatAmount(amount, currency){
      if (amount == null || amount === '') return '';
      // if amount looks like cents (integer and currency present), format as euros
      let num = Number(amount);
      if (!isFinite(num)) return String(amount);
      // Treat large integers as cents
      if (Math.abs(num) > 1000) num = num / 100;
      // Use toLocaleString to format with space thousands and comma decimals (fr-FR)
      return num.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';
    }

    function formatDate(iso){
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      // DD/MM/YYYY HH:mm
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2,'0');
      const min = String(d.getMinutes()).padStart(2,'0');
      return `${dd}/${mm}/${yyyy} ${hh}:${min}`;
    }

    function statusIconFor(s){
      const map = {
        'succeeded': '✔️',
        'failed': '❌',
        'processing': '⏳',
        'requires_payment_method': '⚠️',
        'canceled': '⛔'
      };
      return map[s] || '';
    }

    function renderMetaButton(meta){
      try {
        const j = typeof meta === 'string' && meta ? meta : (meta && typeof meta === 'object' ? JSON.stringify(meta) : '');
        if (!j) return '';
        return `<button class="view-meta" data-meta='${escapeHtml(j)}'>View</button>`;
      } catch (e) { return ''; }
    }

    // Render a View button for bookings that carries booking id and payment_intent
    function renderBookingMetaButton(meta, bookingId, paymentIntentId){
      try {
        const j = typeof meta === 'string' && meta ? meta : (meta && typeof meta === 'object' ? JSON.stringify(meta) : '');
        // always show a view button for bookings even if no metadata, so admin can act on the booking
        const dataMeta = escapeHtml(j);
        const dataB = escapeHtml(String(bookingId || ''));
        const dataPi = escapeHtml(String(paymentIntentId || ''));
        return `<button class="view-booking" data-meta='${dataMeta}' data-booking='${dataB}' data-pi='${dataPi}'>View</button>`;
      } catch (e) { return ''; }
    }

    // show modal when clicking view buttons (payments) or view-booking (bookings)
    document.addEventListener('click', (e) => {
      if (e.target && e.target.classList) {
        if (e.target.classList.contains('view-meta')) {
          const m = e.target.getAttribute('data-meta') || '';
          showMetadataModal(m);
        } else if (e.target.classList.contains('view-booking')) {
          const m = e.target.getAttribute('data-meta') || '';
          const bid = e.target.getAttribute('data-booking') || '';
          const pi = e.target.getAttribute('data-pi') || '';
          showMetadataModal(m, bid, pi);
        }
      }
    });

    // Modal implementation (includes action buttons for bookings)
    const modalBackdrop = document.createElement('div'); modalBackdrop.className = 'modal-backdrop';
    modalBackdrop.innerHTML = `
      <div class="modal">
        <button id="closeModal" style="float:right">Close</button>
        <h3>Metadata</h3>
        <pre id="modalPre"></pre>
        <div style="margin-top:12px">
          <button id="refundBtn" style="background:#dc3545;color:#fff;margin-right:8px">Refund</button>
          <button id="cancelBtn" style="background:#6c757d;color:#fff">Cancel</button>
        </div>
      </div>`;
    document.body.appendChild(modalBackdrop);
    document.getElementById('closeModal').addEventListener('click', () => { modalBackdrop.style.display = 'none'; clearModalState(); });
    async function showMetadataModal(text, bookingId, paymentIntentId){
      const pre = document.getElementById('modalPre');
      // If a booking id is provided, fetch the structured booking and render fields
      if (bookingId) {
        try {
          const res = await fetch('/api/bookings/' + encodeURIComponent(bookingId));
          if (res.ok) {
            const b = await res.json();
            // build a structured display
            const parts = [];
            parts.push('ID: ' + (b.id || ''));
            parts.push('Status: ' + (b.status || ''));
            parts.push('PaymentIntent: ' + (b.payment_intent_id || ''));
            parts.push('Event: ' + (b.event_id || ''));
            parts.push('Name: ' + (b.user_name || ''));
            parts.push('Email: ' + (b.user_email || ''));
            parts.push('Trip: ' + (b.trip_id || ''));
            parts.push('Seats: ' + (b.seats || ''));
            parts.push('Price: ' + (formatAmount(b.price_cents || 0, b.currency || 'eur')));
            parts.push('Created: ' + (formatDate(b.created_at || '') || ''));
            parts.push('\nMetadata:\n' + (typeof b.metadata === 'object' ? JSON.stringify(b.metadata, null, 2) : (b.metadata || '')));
            pre.textContent = parts.join('\n');
          } else {
            // fallback to raw text
            try { pre.textContent = JSON.stringify(JSON.parse(text), null, 2); } catch (e) { pre.textContent = text; }
          }
        } catch (e) {
          try { pre.textContent = JSON.stringify(JSON.parse(text), null, 2); } catch (err) { pre.textContent = text; }
        }
      } else {
        try { pre.textContent = JSON.stringify(JSON.parse(text), null, 2); } catch (e) { pre.textContent = text; }
      }
      // stash booking context on the backdrop for handlers
      modalBackdrop.dataset.booking = bookingId || '';
      modalBackdrop.dataset.pi = paymentIntentId || '';
      // enable/disable buttons depending on presence of bookingId
      document.getElementById('refundBtn').disabled = !bookingId;
      document.getElementById('cancelBtn').disabled = !bookingId;
      modalBackdrop.style.display = 'flex';
    }

    function clearModalState(){
      delete modalBackdrop.dataset.booking;
      delete modalBackdrop.dataset.pi;
      document.getElementById('refundBtn').disabled = true;
      document.getElementById('cancelBtn').disabled = true;
    }

    // Refund and Cancel handlers
    document.getElementById('refundBtn').addEventListener('click', async () => {
      const bookingId = modalBackdrop.dataset.booking;
      if (!bookingId) return alert('No booking id');
      if (!confirm('Really refund booking ' + bookingId + '?')) return;
      try {
        const res = await fetch(`/admin/bookings/${encodeURIComponent(bookingId)}/refund`, { method: 'POST', headers: { Authorization: basicAuth } });
  if (!res.ok) throw new Error('Refund failed: ' + res.status);
  // optimistic update in the bookings table
  updateBookingRowStatus(bookingId, 'refunded');
  alert('Refund request accepted');
  modalBackdrop.style.display = 'none'; clearModalState();
  // refresh the bookings list to reflect server state
  fetchBookings();
      } catch (e) { alert('Refund failed: ' + e); }
    });

    document.getElementById('cancelBtn').addEventListener('click', async () => {
      const bookingId = modalBackdrop.dataset.booking;
      if (!bookingId) return alert('No booking id');
      if (!confirm('Really cancel booking ' + bookingId + '?')) return;
      try {
        const res = await fetch(`/admin/bookings/${encodeURIComponent(bookingId)}/cancel`, { method: 'POST', headers: { Authorization: basicAuth } });
  if (!res.ok) throw new Error('Cancel failed: ' + res.status);
  updateBookingRowStatus(bookingId, 'canceled');
  alert('Booking canceled');
  modalBackdrop.style.display = 'none'; clearModalState();
  // refresh bookings list
  fetchBookings();
      } catch (e) { alert('Cancel failed: ' + e); }
    });

    function updateBookingRowStatus(bookingId, newStatus){
      // find row in bookingsTbody by first cell (id)
      const trs = bookingsTbody.querySelectorAll('tr');
      for (const tr of trs) {
        const td = tr.querySelector('td');
        if (!td) continue;
        if (td.textContent.trim() === bookingId) {
          // second cell holds status
          const statusCell = tr.querySelectorAll('td')[1];
          if (statusCell) {
            statusCell.textContent = newStatus;
          }
          return;
        }
      }
    }

    function escapeHtml(s){
      if (s === null || s === undefined) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function formatMeta(m){
      if (!m) return '';
      try { return typeof m === 'string' ? m : JSON.stringify(m); } catch(e) { return String(m); }
    }

    // Copy current visible table to clipboard as TSV (easily pasteable into Excel)
    document.getElementById('copyExcel').addEventListener('click', async () => {
      const rows = [];
      // headers in Greek
      rows.push(['Κωδικός', 'Κατάσταση', 'Γεγονός', 'Ποσό (€)', 'Νόμισμα', 'Ημερομηνία', 'Μεταδεδομένα']);
      const trs = paymentsTbody.querySelectorAll('tr');
      trs.forEach(tr => {
        const cols = Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim());
        rows.push(cols);
      });
      const tsv = rows.map(r => r.join('\t')).join('\n');
      try {
        await navigator.clipboard.writeText(tsv);
        alert('Αντιγράφηκε στο clipboard. Επικόλλησε σε Excel (Ctrl+V).');
      } catch (e) {
        // fallback: create a hidden textarea
        const ta = document.createElement('textarea');
        ta.value = tsv;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        alert('Αντιγράφηκε στο clipboard (fallback). Επικόλλησε σε Excel.');
      }
    });

    // Modify exportPayments to request CSV with Greek headers from server if possible,
    // otherwise build client-side CSV with Greek headers.
    async function exportPayments(){
      if(!basicAuth) return;
      const btn = document.getElementById('exportPayments');
      btn.disabled = true;
      btn.textContent = 'Ετοιμάζεται...';
      try {
        // build query params from filters
        const params = new URLSearchParams();
        const status = document.getElementById('filterStatus').value;
        const from = document.getElementById('filterFrom').value;
        const to = document.getElementById('filterTo').value;
        const min = document.getElementById('filterMin').value;
        const max = document.getElementById('filterMax').value;
        if (status) params.set('status', status);
        if (from) params.set('from', from);
        if (to) params.set('to', to);
        if (min) params.set('min', Math.round(Number(min)*100));
        if (max) params.set('max', Math.round(Number(max)*100));

        const url = '/admin/payments.csv?' + params.toString();
        const res = await fetch(url, { headers: { Authorization: basicAuth } });
        if (res.ok) {
          // download server CSV directly
          const blob = await res.blob();
          const a = document.createElement('a');
          const downloadUrl = URL.createObjectURL(blob);
          const cd = res.headers.get('Content-Disposition') || '';
          let filename = 'payments.csv';
          const m = cd.match(/filename="?([^";]+)"?/);
          if (m && m[1]) filename = m[1];
          a.href = downloadUrl; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(downloadUrl);
        } else {
          // fallback: build client-side CSV with Greek headers
          const rows = [];
          rows.push(['Κωδικός','Κατάσταση','Γεγονός','Ποσό (€)','Νόμισμα','Ημερομηνία','Μεταδεδομένα']);
          const trs = paymentsTbody.querySelectorAll('tr');
          trs.forEach(tr => {
            const cols = Array.from(tr.querySelectorAll('td')).map(td => '"'+td.textContent.replace(/"/g,'""')+'"');
            rows.push(cols);
          });
          const csv = rows.map(r => r.join(',')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url2 = URL.createObjectURL(blob);
          const a2 = document.createElement('a'); a2.href = url2; a2.download = 'payments.csv'; document.body.appendChild(a2); a2.click(); a2.remove(); URL.revokeObjectURL(url2);
        }
      } catch (err) {
        alert('Εξαγωγή απέτυχε: '+err);
      } finally {
        btn.disabled = false; btn.textContent = 'Εξαγωγή σε CSV';
      }
    }

    function applyFilters(){
      if(!lastPayments) return fetchPayments();
      const status = document.getElementById('filterStatus').value;
      const from = document.getElementById('filterFrom').value;
      const to = document.getElementById('filterTo').value;
      const min = document.getElementById('filterMin').value;
      const max = document.getElementById('filterMax').value;

      const filtered = lastPayments.filter(p => {
        try {
          if (status && String(p.status) !== status) return false;
          if (min) {
            const m = parseInt(min,10);
            if (Number(p.amount) < m) return false;
          }
          if (max) {
            const M = parseInt(max,10);
            if (Number(p.amount) > M) return false;
          }
          if (from) {
            const fromTs = new Date(from + 'T00:00:00Z').getTime();
            const pt = p.timestamp ? new Date(p.timestamp).getTime() : NaN;
            if (isFinite(pt) && pt < fromTs) return false;
          }
          if (to) {
            // include the day
            const toTs = new Date(to + 'T23:59:59Z').getTime();
            const pt = p.timestamp ? new Date(p.timestamp).getTime() : NaN;
            if (isFinite(pt) && pt > toTs) return false;
          }
          return true;
        } catch (e) { return false; }
      });
      renderPayments(filtered);
    }

    function clearFilters(){
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterFrom').value = '';
      document.getElementById('filterTo').value = '';
      document.getElementById('filterMin').value = '';
      document.getElementById('filterMax').value = '';
      if (lastPayments) renderPayments(lastPayments);
    }

    // Export payments to CSV and trigger download
    async function exportPayments(){
      if(!basicAuth) return;
      const btn = document.getElementById('exportPayments');
      btn.disabled = true;
      btn.textContent = 'Preparing...';
      try {
        // build query params from filters
        const params = new URLSearchParams();
        const status = document.getElementById('filterStatus').value;
        const from = document.getElementById('filterFrom').value;
        const to = document.getElementById('filterTo').value;
        const min = document.getElementById('filterMin').value;
        const max = document.getElementById('filterMax').value;
        if (status) params.set('status', status);
        if (from) params.set('from', from);
        if (to) params.set('to', to);
        if (min) params.set('min', min);
        if (max) params.set('max', max);

        const url = '/admin/payments.csv?' + params.toString();
        const res = await fetch(url, { headers: { Authorization: basicAuth } });
        if (!res.ok) throw new Error('Server returned ' + res.status);
        const blob = await res.blob();
        const a = document.createElement('a');
        const downloadUrl = URL.createObjectURL(blob);
        // try to get filename from Content-Disposition
        const cd = res.headers.get('Content-Disposition') || '';
        let filename = 'payments.csv';
        const m = cd.match(/filename="?([^";]+)"?/);
        if (m && m[1]) filename = m[1];
        a.href = downloadUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(downloadUrl);
      } catch (err) {
        alert('Export failed: '+err);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Export CSV';
      }
    }
  </script>
  <script src="/js/i18n.js" defer></script>
</body>
</html>
