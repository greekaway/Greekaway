<!doctype html><html lang="el"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Greekaway Admin – Home</title><link rel="stylesheet" href="/css/admin-common.css"><link rel="stylesheet" href="/css/admin-home.css"><link rel="stylesheet" href="/css/admin-theme-toggle.css"><link rel="manifest" href="/manifest-admin.json"><meta name="theme-color" content="#001f3f"><link rel="stylesheet" href="/pwa.css"><link rel="stylesheet" href="/css/pwa-fixes.css">
<style>
#admin-login-panel {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
  background: linear-gradient(180deg,var(--ga-bg) 0%,var(--ga-bg-2) 100%);
}
#admin-login-panel[hidden], #admin-dashboard[hidden] { display: none !important; }
.login-card {
  width: min(420px, 92vw);
  background: rgba(6,14,26,.92);
  padding: 28px 26px;
  border-radius: 18px;
  box-shadow: 0 20px 60px rgba(0,0,0,.35);
  color: var(--ga-text);
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
}
.login-card h1 { margin: 0 0 6px; font-weight: 600; font-size: 22px; }
.login-card p.sub { margin: 0 0 18px; font-size: 14px; color: var(--ga-muted); }
.login-card label { display: flex; flex-direction: column; gap: 6px; font-size: 14px; margin-bottom: 14px; }
.login-card input {
  border-radius: 10px;
  border: 1px solid var(--ga-border);
  background: rgba(5,16,32,.85);
  color: var(--ga-text);
  padding: 10px 12px;
  font-size: 15px;
}
.login-card input:focus { outline: 2px solid rgba(85,147,255,.8); border-color: transparent; }
#loginBtn {
  width: 100%;
  border: none;
  border-radius: 10px;
  padding: 11px;
  font-size: 16px;
  font-weight: 600;
  color: #03132a;
  background: linear-gradient(135deg,#47c0ff,#0074ff);
  cursor: pointer;
  transition: transform .12s ease, opacity .12s ease;
}
#loginBtn:disabled { opacity: .6; cursor: wait; }
#loginError { min-height: 1.25em; margin: 6px 0 0; font-size: 14px; color: #ff8a8a; }
#admin-dashboard .top-bar {
  display: flex;
  gap: 10px;
  align-items: center;
  justify-content: flex-end;
  margin: 6px 0 12px;
}
html[data-theme='light'] #admin-login-panel {
  background: linear-gradient(180deg,#f7f9ff 0%,#e1e8ff 100%);
}
html[data-theme='light'] .login-card {
  background: rgba(255,255,255,.92);
  box-shadow: 0 20px 60px rgba(20,32,60,.25);
  color: var(--ga-text);
}
html[data-theme='light'] .login-card input {
  background: rgba(255,255,255,.95);
  color: #0f1b2c;
  border: 1px solid rgba(6,24,53,.15);
}
html[data-theme='light'] #loginBtn {
  background: linear-gradient(135deg,#ffc24b,#ff8f00);
  color: #361a00;
}
</style>
</head><body>
<section id="admin-login-panel" aria-label="Admin Login">
  <div class="login-card">
    <h1>Greekaway Admin</h1>
    <p class="sub">Παρακαλώ συνδέσου για πρόσβαση στο διαχειριστικό.</p>
    <form id="loginForm" method="POST" action="/admin-login" novalidate>
      <input type="hidden" id="loginNext" name="next" value="/admin-home.html">
      <label>Username
        <input id="loginUser" name="username" type="text" autocomplete="username" required>
      </label>
      <label>Password
        <input id="loginPass" name="password" type="password" autocomplete="current-password" required>
      </label>
      <button id="loginBtn" type="submit">Login</button>
      <div id="loginError"></div>
      <p class="hint" style="margin-top:14px;font-size:12px;text-align:center;color:#9ab8de;opacity:.9">Τα στοιχεία προέρχονται από το .env (ADMIN_USER / ADMIN_PASS).</p>
    </form>
  </div>
</section>

<section id="admin-dashboard" hidden aria-label="Admin Dashboard">
  <main class="container">
    <div id="homeTopBar" class="top-bar">
      <button id="homeLogoutBtn" class="btn secondary" type="button">Logout</button>
    </div>

    <section class="tiles" aria-label="Σύνολα">
      <div class="tile">
        <h3>Σύνολο κρατήσεων</h3>
        <div class="h1" style="margin:6px 0 0">—</div>
      </div>
      <div class="tile">
        <h3>Σύνολο πληρωμών</h3>
        <div class="h1" style="margin:6px 0 0">—</div>
      </div>
      <div class="tile">
        <h3>Συνεργάτες</h3>
        <div class="h1" style="margin:6px 0 0">—</div>
      </div>
    </section>

    <section class="panel" aria-label="Stripe Partner Tools" style="margin-top:16px">
      <h2 class="h1" style="font-size:20px">Stripe Partner Tools</h2>
      <div id="stripeAlert" style="display:none;margin:8px 0 12px;padding:10px 12px;border-radius:8px;font-size:14px;line-height:1.3"></div>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));align-items:end">
        <label style="display:flex;flex-direction:column;gap:6px">Partner Email
          <input id="homePartnerEmail" class="input" type="email" placeholder="partner@example.com">
        </label>
        <button id="btnStripeOnboarding" class="btn" type="button">Generate Stripe Partner Link</button>
        <button id="btnManualOnboarding" class="btn secondary" type="button">Generate Manual Onboarding Link</button>
      </div>
    </section>
  </main>
  <nav class="bottom-nav">
    <a href="/admin-home.html" class="active">Home</a>
    <a href="/admin-bookings.html">Bookings</a>
    <a href="/admin-payments.html">Payments</a>
    <a href="/admin-manual.html">Manual</a>
    <a href="/admin-providers.html">Providers</a>
    <a href="/admin-availability.html">Availability</a>
    <a href="/admin/trip-availability.html">Trip Availability</a>
  </nav>
  <footer class="version">Greekaway Admin • v<span id="ga-version">—</span></footer>
</section>

<script>
// Version label
fetch('/version.json').then(r=>r.ok?r.json():null).then(v=>{ if(v){const span=document.getElementById('ga-version'); if(span){span.textContent=v.version||'—';}} })

document.addEventListener('DOMContentLoaded', () => {
  const loginPanel = document.getElementById('admin-login-panel');
  const dashboardSection = document.getElementById('admin-dashboard');
  const loginForm = document.getElementById('loginForm');
  const loginBtn = document.getElementById('loginBtn');
  const loginUser = document.getElementById('loginUser');
  const loginPass = document.getElementById('loginPass');
  const loginError = document.getElementById('loginError');
  const loginNext = document.getElementById('loginNext');
  const logoutBtn = document.getElementById('homeLogoutBtn');

  const state = { nextTarget: '/admin-home.html' };
  try {
    const params = new URLSearchParams(window.location.search);
    const nextParam = params.get('next');
    if (nextParam && nextParam.startsWith('/')) {
      state.nextTarget = nextParam;
    }
  } catch(_) {}
  if (loginNext) loginNext.value = state.nextTarget;

  function togglePanels(hasSession){
    if (dashboardSection) dashboardSection.hidden = !hasSession;
    if (loginPanel) loginPanel.hidden = hasSession;
  }

  async function fetchSessionStatus(){
    try {
      const res = await fetch('/api/admin/session', { credentials: 'include' });
      return res && res.ok;
    } catch(_) { return false; }
  }

  async function syncPanels(){
    const ok = await fetchSessionStatus();
    togglePanels(ok);
    return ok;
  }

  function setLoginDisabled(disabled){
    if (loginBtn) loginBtn.disabled = disabled;
    if (loginUser) loginUser.disabled = disabled;
    if (loginPass) loginPass.disabled = disabled;
  }

  if (loginForm) {
    loginForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (loginError) loginError.textContent = '';
      setLoginDisabled(true);
      try {
        const username = (loginUser && loginUser.value || '').trim();
        const password = (loginPass && loginPass.value || '').trim();
        if (!username || !password) {
          if (loginError) loginError.textContent = 'Συμπλήρωσε user και password.';
          setLoginDisabled(false);
          return;
        }
        const body = new URLSearchParams({ username, password, next: state.nextTarget });
        const res = await fetch('/admin-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body,
          credentials: 'include',
          redirect: 'follow'
        });
        if (!res.ok) {
          if (loginError) loginError.textContent = 'Λάθος διαπιστευτήρια.';
          setLoginDisabled(false);
          return;
        }
        const authed = await syncPanels();
        if (authed && state.nextTarget && state.nextTarget !== '/admin-home.html') {
          window.location.href = state.nextTarget;
          return;
        }
      } catch (_) {
        if (loginError) loginError.textContent = 'Σφάλμα σύνδεσης. Προσπάθησε ξανά.';
      } finally {
        setLoginDisabled(false);
      }
    });
  }

  if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
      try { await fetch('/admin-logout', { credentials: 'include' }); } catch(_){ }
      window.location.replace('/admin-home.html');
    });
  }

  (function wireStripeTools(){
    const alertBox = document.getElementById('stripeAlert');
    function showStripeAlert(kind, text) {
      if (!alertBox) return;
      alertBox.textContent = text || '';
      alertBox.style.display = 'block';
      alertBox.style.opacity = '1';
      alertBox.style.transition = 'opacity 300ms ease';
      if (kind === 'ok') {
        alertBox.style.background = '#e9f9ef';
        alertBox.style.color = '#16784f';
        alertBox.style.border = '1px solid #b8ebcd';
      } else {
        alertBox.style.background = '#fdecea';
        alertBox.style.color = '#b42318';
        alertBox.style.border = '1px solid #f5c2c0';
      }
      setTimeout(() => {
        try {
          alertBox.style.opacity = '0';
          setTimeout(() => { alertBox.style.display = 'none'; }, 320);
        } catch(_) {}
      }, 3000);
    }

    const stripeBtn = document.getElementById('btnStripeOnboarding');
    if (stripeBtn) stripeBtn.addEventListener('click', async () => {
      const emailEl = document.getElementById('homePartnerEmail');
      const email = (emailEl && emailEl.value || '').trim();
      if (!email) {
        showStripeAlert('err', '❌ Παρακαλώ εισάγετε email προμηθευτή.');
        return;
      }
      try {
        const res = await fetch('/api/partners/connect-link?email=' + encodeURIComponent(email));
        const j = await res.json().catch(() => ({}));
        if (!res.ok || !j || !j.url) throw new Error(j && j.error ? j.error : ('HTTP ' + res.status));
        showStripeAlert('ok', '✅ Επιτυχής σύνδεση με Stripe.');
        setTimeout(() => { try { window.location.href = j.url; } catch(_) {} }, 200);
      } catch (e) {
        showStripeAlert('err', '❌ Αποτυχία σύνδεσης με Stripe. Παρακαλώ δοκιμάστε ξανά.');
      }
    });

    const manualBtn = document.getElementById('btnManualOnboarding');
    if (manualBtn) manualBtn.addEventListener('click', () => { window.location.href = '/partner-manual-onboarding'; });
  })();

  syncPanels();
});
</script>
<script src="/js/admin-theme-toggle.js"></script>
<script src="/pwa-install.js" defer></script>
<script src="/js/main.js"></script></body></html>
