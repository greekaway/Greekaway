<!doctype html><html lang="el"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Greekaway Admin – Home</title><link rel="stylesheet" href="/css/admin-common.css"><link rel="stylesheet" href="/css/admin-home.css"><link rel="stylesheet" href="/css/admin-theme-toggle.css"><link rel="manifest" href="/manifest-admin.json"><meta name="theme-color" content="#001f3f"><link rel="stylesheet" href="/pwa.css"><link rel="stylesheet" href="/css/pwa-fixes.css">
<style>
/* Subtle vertical tweak for desktop/tablet only; keep mobile unchanged */
@media (min-width: 768px) {
  #homeLoginBtn { position: relative; top: 2px; }
}
</style>
</head><body>
<main class="container">
  <div id="homeTopBar" style="display:none;display:flex;gap:10px;align-items:center;justify-content:flex-end;margin:6px 0 12px">
    <button id="homeLogoutBtn" class="btn secondary" type="button">Logout</button>
  </div>
  <!-- Πάνω μέρος: Ενσωματωμένο login (λειτουργικό) -->
  <section class="panel" id="loginSection" aria-label="Login">
    <h1 class="h1">Login</h1>
    <!-- Error now appears above inputs to keep the Login button position stable -->
    <div id="homeLoginErr" class="hint" style="min-height:1.25em;color:#ff8888;margin:0 0 4px 0"></div>
    <form id="homeLoginForm" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));align-items:end" method="POST" action="/admin-login" novalidate>
      <label style="display:flex;flex-direction:column;gap:6px">User
        <input id="homeUser" name="username" class="input" type="text" placeholder="admin" autocomplete="username" required>
      </label>
      <label style="display:flex;flex-direction:column;gap:6px">Pass
        <input id="homePass" name="password" class="input" type="password" autocomplete="current-password" required>
      </label>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button id="homeLoginBtn" class="btn" type="submit">Login</button>
      </div>
    </form>
  </section>

  <!-- Κεντρικό: σύνολα -->
  <section class="tiles" aria-label="Σύνολα">
    <div class="tile">
      <h3>Σύνολο κρατήσεων</h3>
      <div class="h1" style="margin:6px 0 0">—</div>
    </div>
    <div class="tile">
      <h3>Σύνολο πληρωμών</h3>
      <div class="h1" style="margin:6px 0 0">—</div>
    </div>
    <div class="tile">
      <h3>Συνεργάτες</h3>
      <div class="h1" style="margin:6px 0 0">—</div>
    </div>
  </section>

  <!-- Κάτω: Stripe Partner Tools -->
  <section class="panel" aria-label="Stripe Partner Tools" style="margin-top:16px">
    <h2 class="h1" style="font-size:20px">Stripe Partner Tools</h2>
    <div id="stripeAlert" style="display:none;margin:8px 0 12px;padding:10px 12px;border-radius:8px;font-size:14px;line-height:1.3"></div>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));align-items:end">
      <label style="display:flex;flex-direction:column;gap:6px">Partner Email
        <input id="homePartnerEmail" class="input" type="email" placeholder="partner@example.com">
      </label>
      <button id="btnStripeOnboarding" class="btn" type="button">Generate Stripe Partner Link</button>
      <button id="btnManualOnboarding" class="btn secondary" type="button">Generate Manual Onboarding Link</button>
    </div>
  </section>
 </main>
 <nav class="bottom-nav">
   <a href="/admin-home.html" class="active">Home</a>
   <a href="/admin-bookings.html">Bookings</a>
   <a href="/admin-payments.html">Payments</a>
   <a href="/admin-manual.html">Manual</a>
   <a href="/admin-providers.html">Providers</a>
   <a href="/admin-availability.html">Availability</a>
 </nav>
 <footer class="version">Greekaway Admin • v<span id="ga-version">—</span></footer>
  <script>
  // Version label
  fetch('/version.json').then(r=>r.ok?r.json():null).then(v=>{ if(v){document.getElementById('ga-version').textContent=v.version||'—'} })

  function setLoginEnabled(enabled){
    try {
      const btn = document.getElementById('homeLoginBtn');
      const u = document.getElementById('homeUser');
      const p = document.getElementById('homePass');
      if (btn) btn.disabled = !enabled;
      if (u) u.disabled = !enabled;
      if (p) p.disabled = !enabled;
    } catch(_) {}
  }

  async function checkSessionAndToggle(){
    try {
      // Lightweight protected endpoint to test cookie session
      const r = await fetch('/admin/backup-status', { credentials: 'same-origin' });
      const hasSession = r && r.ok;
      const sec = document.getElementById('loginSection');
      if (sec) sec.style.display = hasSession ? 'none' : '';
      const top = document.getElementById('homeTopBar'); if (top) top.style.display = hasSession ? 'flex' : 'none';
    } catch(_) {
      const sec = document.getElementById('loginSection');
      if (sec) sec.style.display = '';
      const top = document.getElementById('homeTopBar'); if (top) top.style.display = 'none';
    }
  }

  function showLoginError(msg){
    const el = document.getElementById('homeLoginErr');
    if (el) el.textContent = msg || '';
  }

  function wireHomeLogin(){
    const form = document.getElementById('homeLoginForm');
    if (!form) return;
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      showLoginError('');
      setLoginEnabled(false);
      try {
        const user = (document.getElementById('homeUser').value||'').trim();
        const pass = (document.getElementById('homePass').value||'').trim();
        const body = new URLSearchParams({ username: user, password: pass, next: '/admin-home.html' });
        // Use form-encoded POST to existing /admin-login route; allow redirect in fetch, keep page here
        const res = await fetch('/admin-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body,
          credentials: 'same-origin',
          redirect: 'follow'
        });
        if (!res.ok) {
          showLoginError('Λάθος διαπιστευτήρια.');
          setLoginEnabled(true);
          return;
        }
        // Cookie should now be set; verify and hide form
        await checkSessionAndToggle();
      } catch (err) {
        showLoginError('Σφάλμα σύνδεσης.');
      } finally {
        setLoginEnabled(true);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    wireHomeLogin();
    try {
      const btn = document.getElementById('homeLogoutBtn');
      if (btn) btn.addEventListener('click', async () => {
        try { await fetch('/admin-logout', { credentials: 'same-origin' }); } catch(_){ }
        // Reload page to reflect logged-out state
        location.replace('/admin-home.html');
      });
    } catch(_){ }
    // Wire onboarding buttons: simple redirects (no data changes)
    try {
      // Helper to show alert bars (auto-hide with fadeout)
      const alertBox = document.getElementById('stripeAlert');
      function showStripeAlert(kind, text) {
        if (!alertBox) return;
        alertBox.textContent = text || '';
        alertBox.style.display = 'block';
        alertBox.style.opacity = '1';
        alertBox.style.transition = 'opacity 300ms ease';
        if (kind === 'ok') {
          alertBox.style.background = '#e9f9ef';
          alertBox.style.color = '#16784f';
          alertBox.style.border = '1px solid #b8ebcd';
        } else {
          alertBox.style.background = '#fdecea';
          alertBox.style.color = '#b42318';
          alertBox.style.border = '1px solid #f5c2c0';
        }
        // Auto-hide after ~3s
        setTimeout(() => {
          try {
            alertBox.style.opacity = '0';
            setTimeout(() => { alertBox.style.display = 'none'; }, 320);
          } catch(_) {}
        }, 3000);
      }

      const stripeBtn = document.getElementById('btnStripeOnboarding');
      if (stripeBtn) stripeBtn.addEventListener('click', async () => {
        const emailEl = document.getElementById('homePartnerEmail');
        const email = (emailEl && emailEl.value || '').trim();
        if (!email) {
          showStripeAlert('err', '❌ Παρακαλώ εισάγετε email προμηθευτή.');
          return;
        }
        try {
          // Reuse existing backend flow to create an onboarding link
          const res = await fetch('/api/partners/connect-link?email=' + encodeURIComponent(email));
          const j = await res.json().catch(() => ({}));
          if (!res.ok || !j || !j.url) throw new Error(j && j.error ? j.error : ('HTTP ' + res.status));
          showStripeAlert('ok', '✅ Επιτυχής σύνδεση με Stripe.');
          // Navigate to Stripe onboarding URL after a tiny delay so the alert flashes briefly
          setTimeout(() => { try { window.location.href = j.url; } catch(_) {} }, 200);
        } catch (e) {
          showStripeAlert('err', '❌ Αποτυχία σύνδεσης με Stripe. Παρακαλώ δοκιμάστε ξανά.');
        }
      });
      const manualBtn = document.getElementById('btnManualOnboarding');
      if (manualBtn) manualBtn.addEventListener('click', () => { window.location.href = '/partner-manual-onboarding'; });
    } catch(_){ }
    checkSessionAndToggle();
  });
  </script>
  <script src="/js/admin-theme-toggle.js"></script>
  <script src="/pwa-install.js" defer></script>
<script src="/js/main.js"></script></body></html>
