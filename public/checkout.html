<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Checkout — Greekaway</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <style>
    main { padding: 100px 16px 120px; max-width:720px; margin:0 auto; }
    .form-row { margin-bottom: 1rem; }
    label { display:block; margin-bottom:0.25rem; }
    input[type=text], input[type=email] { width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; }
    .btn { background:#004080; color:#fff; padding:10px 14px; border-radius:8px; border:none; cursor:pointer; }
    .result { margin-top:1rem; padding:12px; border-radius:8px; }
    /* Centered header with absolute back button */
    .checkout-header { position: relative; display:flex; align-items:center; justify-content:center; margin-bottom:0.5rem; min-height:44px; }
    .checkout-header .back-btn { position:absolute; left:0; top:50%; transform:translateY(-50%); }
    .checkout-header .title-wrap { text-align:center; }
    .checkout-header .title-wrap small { display:block; opacity:0.7; font-size:0.8rem; }
    .checkout-header .title-wrap h1 { margin:0; font-size:1.25rem; }
    .checkout-subtitle { text-align:center; margin-top:0.25rem; }
  </style>
</head>
<body>
  <div style="position:fixed;top:8px;right:12px;z-index:999">
    <select id="langSelect" aria-label="Language"></select>
  </div>
  <main>
    <div class="checkout-header">
      <button type="button" class="back-btn three-d" onclick="history.back()" data-i18n-aria="ui.close">
        <i class="fas fa-arrow-left"></i>
      </button>
      <div class="title-wrap">
  <small data-i18n="nav.home">Επιστροφή</small>
  <h1 data-i18n="checkout.title">Checkout — Greekaway</h1>
      </div>
    </div>
  <p class="checkout-subtitle" data-i18n="checkout.notice">Secure Payment via Stripe</p>

    <form id="checkoutForm">
      <!-- Payment Request Button (Apple Pay / Google Pay) will mount here when available -->
      <div id="payment-request-container" style="display:none;margin-bottom:1rem;"></div>
      <div class="form-row">
  <label data-i18n="checkout.name">Όνομα</label>
        <input name="name" type="text" required>
      </div>
      <div class="form-row">
  <label data-i18n="checkout.email">Email</label>
        <input name="email" type="email" required>
      </div>
      <div class="form-row">
  <label data-i18n="checkout.cardLabel">Κάρτα</label>
  <input name="card" type="text" data-i18n-placeholder="checkout.cardPlaceholder" placeholder="Card number">
      </div>
  <button class="btn" type="submit" data-i18n-value="checkout.pay">Pay</button>
    </form>

    <div id="result" class="result" aria-live="polite" style="display:none;"></div>
  </main>

  <script src="https://js.stripe.com/v3/"></script>
  <script src="/js/payment-request.js"></script>
  <script src="/js/feedback.js" defer></script>
    <script src="/js/i18n.js" defer></script>
  <script>
    // Client-side Stripe integration (scaffold). Requires STRIPE_PUBLISHABLE_KEY set on server
    const STRIPE_PUBLISHABLE = '%STRIPE_PUBLISHABLE_KEY%'; // replaced server-side if needed
    const form = document.getElementById('checkoutForm');
    const resultEl = document.getElementById('result');

    function resolveI18n(m){
      if (typeof m === 'string' && m.indexOf('i18n:') === 0) {
        const key = m.slice(5);
        try { return window.t ? window.t(key) : key; } catch(e) { return key; }
      }
      return m;
    }
    function showResult(msg, success){
      const text = resolveI18n(msg);
      resultEl.style.display='block'; resultEl.textContent=text; resultEl.style.background = success ? '#e6ffe6' : '#ffe6e6';
    }

    (async function(){
    // If landed with a bookingId, fetch booking and prefill name/email
    try {
      const qs = new URLSearchParams(window.location.search);
      const bid = qs.get('bookingId');
      if (bid) {
        const bk = await fetch('/api/bookings/' + encodeURIComponent(bid));
        if (bk && bk.ok) {
          const jb = await bk.json();
          try { if (jb.user_name) form.name.value = jb.user_name; } catch(e){}
          try { if (jb.user_email) form.email.value = jb.user_email; } catch(e){}
        }
      }
    } catch(e) { /* ignore prefill errors */ }
    console.debug('[checkout] STRIPE_PUBLISHABLE present?', !!STRIPE_PUBLISHABLE);
    if (STRIPE_PUBLISHABLE && !STRIPE_PUBLISHABLE.includes('STRIPE')) {
      console.debug('[checkout] Stripe lib loaded?', typeof Stripe !== 'undefined');
      console.debug('[checkout] GWPaymentRequest available?', !!window.GWPaymentRequest && !!window.GWPaymentRequest.init);
      try { console.debug('[checkout] Stripe publishable (masked):', STRIPE_PUBLISHABLE && STRIPE_PUBLISHABLE.slice(0,8) + '...'); } catch(e){}
      
      // Initialize Stripe + Elements + Payment Request (Apple Pay / Google Pay)
      const stripe = Stripe(STRIPE_PUBLISHABLE);
      const elements = stripe.elements();

  // Create and mount separate card Elements (number, expiry, cvc) for clearer layout
  const cardInput = document.querySelector('input[name="card"]');
  if (cardInput) cardInput.style.display = 'none';
  const cardWrapper = document.createElement('div');
  cardWrapper.style.marginBottom = '1rem';
  cardWrapper.className = 'card-elements-wrapper';

  // Number
  const numberLabel = document.createElement('label');
  numberLabel.textContent = 'Αριθμός κάρτας';
  numberLabel.className = 'card-field-label';
  const cardNumberMount = document.createElement('div');
  cardNumberMount.className = 'card-number-mount stripe-mount';
  cardWrapper.appendChild(numberLabel);
  cardWrapper.appendChild(cardNumberMount);

  // Expiry + CVC row
  const smallRow = document.createElement('div');
  smallRow.style.display = 'flex';
  smallRow.style.gap = '12px';

  const expiryLabel = document.createElement('label');
  expiryLabel.textContent = 'MM / EE';
  expiryLabel.className = 'card-field-label';
  const cvcLabel = document.createElement('label');
  cvcLabel.textContent = 'CVC';
  cvcLabel.className = 'card-field-label small';

  const cardExpiryMount = document.createElement('div');
  cardExpiryMount.className = 'card-expiry-mount stripe-mount';
  cardExpiryMount.style.flex = '1';
  const cardCvcMount = document.createElement('div');
  cardCvcMount.className = 'card-cvc-mount stripe-mount';
  cardCvcMount.style.width = '120px';

  const expiryWrapper = document.createElement('div');
  expiryWrapper.style.flex = '1';
  expiryWrapper.appendChild(expiryLabel);
  expiryWrapper.appendChild(cardExpiryMount);

  const cvcWrapper = document.createElement('div');
  cvcWrapper.style.width = '120px';
  cvcWrapper.appendChild(cvcLabel);
  cvcWrapper.appendChild(cardCvcMount);

  smallRow.appendChild(expiryWrapper);
  smallRow.appendChild(cvcWrapper);
  cardWrapper.appendChild(smallRow);

  const formParent = cardInput ? cardInput.parentNode : form;
  formParent.insertBefore(cardWrapper, formParent.querySelector('.btn'));

  const cardNumber = elements.create('cardNumber', { showIcon: true });
  const cardExpiry = elements.create('cardExpiry');
  const cardCvc = elements.create('cardCvc');

  cardNumber.mount(cardNumberMount);
  cardExpiry.mount(cardExpiryMount);
  cardCvc.mount(cardCvcMount);

      // Payment Request (Apple Pay / Google Pay) setup via helper
      try {
        if (window.GWPaymentRequest && window.GWPaymentRequest.init) {
          console.debug('[checkout] calling GWPaymentRequest.init...');
          const pr = await window.GWPaymentRequest.init(STRIPE_PUBLISHABLE, { total: { label: 'Greekaway — Προκαταβολή', amount: 1000 } });
          console.debug('[checkout] GWPaymentRequest.init returned', pr);
          if (pr && pr.prButton) {
            document.getElementById('payment-request-container').style.display = 'block';
            try { pr.prButton.mount('#payment-request-container'); } catch (err) { console.error('[checkout] mount prButton failed', err); }

            pr.paymentRequest.on('paymentmethod', async (ev) => {
              try {
                const resp = await fetch('/create-payment-intent', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ amount: 1000, currency: 'eur' }) });
                const data = await resp.json();
                if (!data.clientSecret) { ev.complete('fail'); return showResult('i18n:checkout.payment_error', false); }

                const confirm = await pr.stripe.confirmCardPayment(data.clientSecret, { payment_method: ev.paymentMethod.id }, { handleActions: false });
                if (confirm.error) { ev.complete('fail'); return showResult(confirm.error.message || 'i18n:checkout.payment_failed', false); }
                if (confirm.paymentIntent && confirm.paymentIntent.status === 'requires_action') {
                  const res2 = await pr.stripe.confirmCardPayment(data.clientSecret);
                  if (res2.error) { ev.complete('fail'); return showResult(res2.error.message || 'i18n:checkout.payment_failed', false); }
                }

                ev.complete('success');
                showResult('i18n:checkout.payment_success_test', true);
              } catch (err) { console.error('paymentRequest handler error', err); ev.complete('fail'); showResult('i18n:checkout.payment_error', false); }
            });
          }
        }
      } catch (e) { console.warn('Payment Request init failed', e); }

      // Classic card form fallback
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = form.name.value;
        const email = form.email.value;
        // Derive booking id or create a booking first (to persist traveler profile)
        const qs = new URLSearchParams(window.location.search);
        let bookingId = qs.get('bookingId');
        const tripId = qs.get('trip');
        try {
          if (!bookingId && tripId) {
            // collect profile from sessionStorage (Step 2)
            const ss = (k,d='')=>{ try{ const v=sessionStorage.getItem(k); return v==null?d:v; }catch(_){ return d; } };
            const adults = parseInt(ss('gw_adults','2'),10) || 2;
            let childrenAges = [];
            try { childrenAges = JSON.parse(ss('gw_children_ages','[]')) || []; } catch(_){ childrenAges = []; }
            const seats = Math.max(1, adults + (childrenAges.length||0));
            const payload = {
              trip_id: tripId,
              date: null,
              seats,
              user_name: name,
              user_email: email,
              price_cents: 1000,
              currency: 'eur',
              language: ss('gw_lang','el') || null,
              age_group: ss('gw_age_group','') || null,
              traveler_type: ss('gw_traveler_type','') || null,
              interest: ss('gw_interest','') || null,
              sociality: ss('gw_sociality','') || null,
              children_ages: childrenAges
            };
            const r = await fetch('/api/bookings', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
            const j = await r.json();
            if (r.ok && j.bookingId) bookingId = j.bookingId;
          }
        } catch (err) { console.warn('[checkout] create booking failed (continuing)', err); }

        // create payment intent on server (amount in cents) — example 10 EUR, include booking_id for linkage
        const body = { amount: 1000, currency: 'eur' };
        if (bookingId) body.booking_id = bookingId;
        const resp = await fetch('/create-payment-intent', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const data = await resp.json();
        if(!data.clientSecret) return showResult('i18n:checkout.payment_error', false);
        const { error } = await stripe.confirmCardPayment(data.clientSecret, { payment_method: { card: cardNumber, billing_details: { name, email } } });
        if(error) showResult(error.message || 'i18n:checkout.payment_failed', false);
        else showResult('i18n:checkout.payment_success_test', true);
      });
    } else {
      // Fallback: use mock endpoint
      form.addEventListener('submit', function(e){
        e.preventDefault();
        var fd = new FormData(e.target);
        fetch('/mock-checkout', { method:'POST', body: new URLSearchParams(fd) })
          .then(r => r.json())
          .then(j => showResult(j.message || 'i18n:checkout.mock_complete', j.success))
            .catch(err => showResult('i18n:checkout.network_error', false));
      });
    }
    })();
    try { window.GWFeedbackPrompt && window.GWFeedbackPrompt.init && window.GWFeedbackPrompt.init(); } catch(e){}
  </script>
</body>
</html>
