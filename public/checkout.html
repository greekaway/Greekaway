<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Checkout — Greekaway (Mock)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <style>
    main { padding: 100px 16px 120px; max-width:720px; margin:0 auto; }
    .form-row { margin-bottom: 1rem; }
    label { display:block; margin-bottom:0.25rem; }
    input[type=text], input[type=email] { width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; }
    .btn { background:#004080; color:#fff; padding:10px 14px; border-radius:8px; border:none; cursor:pointer; }
    .result { margin-top:1rem; padding:12px; border-radius:8px; }
  </style>
</head>
<body>
  <main>
    <div style="display:flex;align-items:center;justify-content:flex-start;gap:12px;margin-bottom:1rem;">
      <button type="button" class="back-btn three-d" onclick="history.back()" aria-label="Πίσω" style="position:relative;left:0;">
        <i class="fas fa-arrow-left"></i>
      </button>
      <div style="display:flex;flex-direction:column;">
        <small style="color:rgba(255,255,255,0.6);font-size:0.8rem;">Επιστροφή</small>
        <h1 style="margin:0;font-size:1.25rem">Mock Checkout</h1>
      </div>
    </div>
    <p>Αυτό είναι ένα δοκιμαστικό checkout. Δεν θα γίνει πραγματική χρέωση.</p>

    <form id="checkoutForm">
      <!-- Payment Request Button (Apple Pay / Google Pay) will mount here when available -->
      <div id="payment-request-container" style="display:none;margin-bottom:1rem;"></div>
      <div class="form-row">
        <label>Όνομα</label>
        <input name="name" type="text" required>
      </div>
      <div class="form-row">
        <label>Email</label>
        <input name="email" type="email" required>
      </div>
      <div class="form-row">
        <label>Κάρτα (mock)</label>
        <input name="card" type="text" placeholder="4242 4242 4242 4242">
      </div>
      <button class="btn" type="submit">Πλήρωσε (mock)</button>
    </form>

    <div id="result" class="result" aria-live="polite" style="display:none;"></div>
  </main>

  <script src="https://js.stripe.com/v3/"></script>
  <script>
    // Client-side Stripe integration (scaffold). Requires STRIPE_PUBLISHABLE_KEY set on server
    const STRIPE_PUBLISHABLE = '%STRIPE_PUBLISHABLE_KEY%'; // replaced server-side if needed
    const form = document.getElementById('checkoutForm');
    const resultEl = document.getElementById('result');

    function showResult(msg, success){ resultEl.style.display='block'; resultEl.textContent=msg; resultEl.style.background = success ? '#e6ffe6' : '#ffe6e6'; }

    if (STRIPE_PUBLISHABLE && !STRIPE_PUBLISHABLE.includes('STRIPE')) {
      // Initialize Stripe + Elements + Payment Request (Apple Pay / Google Pay)
      const stripe = Stripe(STRIPE_PUBLISHABLE);
      const elements = stripe.elements();

  // Create and mount separate card Elements (number, expiry, cvc) for clearer layout
  const cardInput = document.querySelector('input[name="card"]');
  if (cardInput) cardInput.style.display = 'none';
  const cardWrapper = document.createElement('div');
  cardWrapper.style.marginBottom = '1rem';
  cardWrapper.className = 'card-elements-wrapper';

  // Number
  const numberLabel = document.createElement('label');
  numberLabel.textContent = '';
  numberLabel.style.display = 'block';
  numberLabel.style.marginBottom = '6px';
  const cardNumberMount = document.createElement('div');
  cardNumberMount.className = 'card-number-mount';
  cardWrapper.appendChild(cardNumberMount);

  // Expiry + CVC row
  const smallRow = document.createElement('div');
  smallRow.style.display = 'flex';
  smallRow.style.gap = '12px';

  const cardExpiryMount = document.createElement('div');
  cardExpiryMount.style.flex = '1';
  const cardCvcMount = document.createElement('div');
  cardCvcMount.style.width = '120px';

  smallRow.appendChild(cardExpiryMount);
  smallRow.appendChild(cardCvcMount);
  cardWrapper.appendChild(smallRow);

  const formParent = cardInput ? cardInput.parentNode : form;
  formParent.insertBefore(cardWrapper, formParent.querySelector('.btn'));

  const cardNumber = elements.create('cardNumber', { showIcon: true });
  const cardExpiry = elements.create('cardExpiry');
  const cardCvc = elements.create('cardCvc');

  cardNumber.mount(cardNumberMount);
  cardExpiry.mount(cardExpiryMount);
  cardCvc.mount(cardCvcMount);

      // Payment Request (Apple Pay / Google Pay) setup
      const paymentRequest = stripe.paymentRequest({
        country: 'GR',
        currency: 'eur',
        total: { label: 'Greekaway — Προκαταβολή', amount: 1000 }, // amount in cents
        requestPayerName: true,
        requestPayerEmail: true,
      });

      paymentRequest.canMakePayment().then(function(result) {
        if (result) {
          // Show the payment request button
          document.getElementById('payment-request-container').style.display = 'block';
          const prButton = elements.create('paymentRequestButton', { paymentRequest });
          prButton.mount('#payment-request-container');
        }
      }).catch(err => console.warn('paymentRequest.canMakePayment error', err));

      // Handle the paymentrequest flow
      paymentRequest.on('paymentmethod', async (ev) => {
        try {
          // Create PaymentIntent on the server for the requested amount
          const resp = await fetch('/create-payment-intent', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ amount: 1000, currency: 'eur' }) });
          const data = await resp.json();
          if (!data.clientSecret) {
            ev.complete('fail');
            return showResult('Πρόβλημα με πληρωμή', false);
          }

          // Confirm the payment using the payment method returned by the browser
          const confirm = await stripe.confirmCardPayment(data.clientSecret, { payment_method: ev.paymentMethod.id }, { handleActions: false });
          if (confirm.error) {
            ev.complete('fail');
            return showResult(confirm.error.message || 'Payment failed', false);
          }

          if (confirm.paymentIntent && confirm.paymentIntent.status === 'requires_action') {
            // Handle next actions (3DS) if required
            const res2 = await stripe.confirmCardPayment(data.clientSecret);
            if (res2.error) {
              ev.complete('fail');
              return showResult(res2.error.message || 'Payment failed', false);
            }
          }

          ev.complete('success');
          showResult('Payment successful (test)', true);
        } catch (err) {
          console.error('paymentRequest handler error', err);
          ev.complete('fail');
          showResult('Σφάλμα πληρωμής', false);
        }
      });

      // Classic card form fallback
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = form.name.value;
        const email = form.email.value;
        // create payment intent on server (amount in cents) — example 10 EUR
        const resp = await fetch('/create-payment-intent', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ amount: 1000, currency: 'eur' }) });
        const data = await resp.json();
        if(!data.clientSecret) return showResult('Πρόβλημα με πληρωμή', false);
  const { error } = await stripe.confirmCardPayment(data.clientSecret, { payment_method: { card: cardNumber, billing_details: { name, email } } });
        if(error) showResult(error.message || 'Payment failed', false);
        else showResult('Payment successful (test)', true);
      });
    } else {
      // Fallback: use mock endpoint
      form.addEventListener('submit', function(e){
        e.preventDefault();
        var fd = new FormData(e.target);
        fetch('/mock-checkout', { method:'POST', body: new URLSearchParams(fd) })
          .then(r => r.json())
          .then(j => showResult(j.message || 'Ολοκληρώθηκε (mock)', j.success))
          .catch(err => showResult('Σφάλμα δικτύου', false));
      });
    }
  </script>
</body>
</html>
