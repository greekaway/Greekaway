<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Greekaway – Βήμα 2</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <style>
    /* Stage 1: surface tokens to break blue monotony safely */
    :root {
      --panel-top: 5vh;
      --s2-offset-under-header: 36px;
      /* Surfaces */
      --surface-band-top: rgba(84, 122, 176, 0.38);   /* lighter blue */
      --surface-band-bot: rgba(54, 86, 136, 0.30);
      --surface-card-top: rgba(58, 78, 102, 0.98);    /* slightly different than before */
      --surface-card-bot: rgba(36, 50, 68, 0.98);
    }
    /* Keep page absolutely minimal and clean */
    html, body { height: 100%; }
    body {
      margin: 0;
      background-image: var(--site-gradient);
      background-color: var(--site-bg-color);
    }
    /* Middle band (same sizing/placement as step1 calendar band) */
    .step2-band {
      position: fixed; /* anchor to viewport like an overlay */
      top: var(--panel-top);
      left: 50%;
      transform: translateX(-50%);
      width: min(780px, calc(100vw - 56px));
      bottom: -80px; /* extend under the footer (~64px) so it goes behind it */
      margin: 0; padding: 0;
      overflow: hidden;
      /* subtle lighter blue layer to separate from site bg */
      background: linear-gradient(180deg, var(--surface-band-top) 0%, var(--surface-band-bot) 100%);
      border-radius: 18px;
      pointer-events: none; /* purely decorative container for now */
    }
    /* The actual dark card panel (mirrors step1 .flatpickr-calendar look) */
    .step2-card {
      position: absolute;
      inset: 0;
      /* Slightly darker than band for depth */
      background: linear-gradient(180deg, var(--surface-card-top) 0%, var(--surface-card-bot) 100%);
      border-radius: 16px;
      /* Refined shadow for clearer elevation without heavy spread */
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.055),
        inset 0 1px 0 rgba(255,255,255,0.07),
        inset 0 -1px 0 rgba(0,0,0,0.30),
        0 14px 28px -12px rgba(0,0,0,0.55),
        0 36px 80px -24px rgba(0,0,0,0.60);
      will-change: transform, box-shadow;
    }
    @media (max-width: 599px) {
      .step2-band { width: calc(100vw - 40px); }
    }
    /* Optional center marker to verify blank page visually; kept hidden by default */
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,1px,1px); white-space: nowrap; border: 0; }

    /* Step 2 action bar — same placement/look as Step 1 */
    .s2-actions {
      position: fixed;
      left: 0; right: 0;
      bottom: calc(64px + env(safe-area-inset-bottom) + 32px);
      display: flex;
      justify-content: center; /* κεντραρισμένα */
      align-items: center;
      padding: 0 20px;
      box-sizing: border-box;
      gap: 18px; /* πιο κοντά μεταξύ τους */
      z-index: 13001; /* above global footer (z-index ~12000) */
      max-width: 520px;
      margin: 0 auto;
    }
    @media (max-width: 599px) {
      .s2-actions { padding: 0 16px; bottom: calc(64px + env(safe-area-inset-bottom) + 34px); max-width: 440px; gap: 16px; }
    }
    .s2-actions .btn {
      background: #0E1520; /* official dark navy */
      color: #fff;
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 16px;
      padding: 12px 18px; /* ένα ακόμη κλικ πιο αδύνατα */
      font-size: 1.03rem; /* ελαφρώς μικρότερα */
      font-weight: 800;
      letter-spacing: 0.02em;
      min-width: 114px; /* ελάχιστη μείωση */
      box-shadow:
        0 10px 18px rgba(0,0,0,0.35),
        0 4px 10px rgba(0,0,0,0.25),
        inset 0 1px 0 rgba(255,255,255,0.06),
        inset 0 -1px 0 rgba(0,0,0,0.28);
      transition: transform 140ms ease, box-shadow 160ms ease, background 160ms ease;
      cursor: pointer;
    }
    .s2-actions .btn:hover { background: #122033; box-shadow: 0 12px 22px rgba(0,0,0,0.4), 0 6px 12px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.07), inset 0 -1px 0 rgba(0,0,0,0.3); }
    .s2-actions .btn:active { transform: translateY(1px); box-shadow: 0 6px 10px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.05), inset 0 -1px 0 rgba(0,0,0,0.3); }

    /* Title + description header above the panel */
    .step2-header {
      position: fixed;
      top: 0px; /* another +3 clicks (~12px) */
      left: 0; right: 0;
      display: flex; flex-direction: column; align-items: center;
      gap: 6px;
      color: var(--color-text, #e8edf2);
      z-index: 5;
      padding: 0 16px;
      text-align: center;
    }
    .step2-header .trip-title {
      font-weight: 800;
      /* ~+20% συνολικά από το αρχικό */
      font-size: clamp(1.44rem, 2.88vw + 0.96rem, 2.28rem);
      letter-spacing: 0.4px;
      text-shadow: 0 2px 16px rgba(0,0,0,0.35);
    }
    .step2-header .trip-desc { display: none; }

    /* Inline fields under the header inside the top of the panel */
    .s2-fields {
      position: fixed;
      left: 50%; transform: translateX(-50%);
      top: calc(var(--panel-top) + var(--s2-offset-under-header));
      width: min(780px, calc(100vw - 56px));
      z-index: 20000; /* above footer/actions to keep dropdowns on top */
      color: #fff;
      font-weight: 800; /* white bold text as requested */
    }
    @media (max-width: 599px) {
      .s2-fields { width: calc(100vw - 40px); }
      :root { --s2-offset-under-header: 32px; }
    }
    .s2-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; position: relative; }
    .s2-row + .s2-row {
      border-top: 1px solid rgba(0,0,0,0.45); /* darker hairline */
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06); /* subtle top highlight for 3D ridge */
    }
    .s2-labels { display: flex; flex-direction: column; gap: 4px; }
    .s2-labels .title { color: #fff; font-weight: 800; }
    .s2-labels .sub { color: #fff; font-weight: 800; opacity: 0.92; font-size: 0.95rem; }
    /* Center ages display between label and minus */
    .s2-ages { flex: 1; text-align: center; color: #fff; font-weight: 800; opacity: 0.95; }
    .s2-ages .hint { opacity: 0.7; font-weight: 700; }
    .s2-counter { display: flex; align-items: center; gap: 10px; }
    .s2-counter .btn-round {
      width: 36px; height: 36px; border-radius: 10px; /* rounded square */
      background: #0E1520; color: #fff; border: 1px solid rgba(255,255,255,0.16);
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 20px; font-weight: 800; cursor: pointer;
      box-shadow: 0 6px 14px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);
      transition: transform 140ms ease, background 160ms ease, box-shadow 160ms ease;
    }
    .s2-counter .btn-round:active { transform: translateY(1px); box-shadow: 0 4px 10px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05); }
    .s2-counter .count { min-width: 28px; text-align: center; font-size: 1.05rem; font-weight: 800; color: #fff; }

    /* Popover grid for choosing child age 1..17 */
    .age-picker { position: absolute; left: 50%; transform: translateX(-50%); top: calc(100% + 8px);
      background: #0E1520; color: #fff; border: 1px solid rgba(255,255,255,0.16); border-radius: 12px; padding: 12px; z-index: 21000;
      box-shadow: 0 16px 36px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.04);
      display: grid; grid-template-columns: repeat(6, 36px); gap: 8px; pointer-events: auto;
    }
    .age-picker.dropup { top: auto; bottom: calc(100% + 8px); }
    .age-picker button { width: 36px; height: 36px; border-radius: 8px; background: #142132; color: #fff; border: 1px solid rgba(255,255,255,0.16); font-weight: 800; cursor: pointer; }
    .age-picker button:hover { background: #1B2B42; }
    .age-picker[hidden] { display: none; }

  /* Language selector on the right */
  .s2-right { display: flex; align-items: center; gap: 10px; }
  .lang-select { background:#0E1520; color:#fff; border:1px solid rgba(255,255,255,0.16); border-radius:12px; padding:8px 12px; font-weight:800; display:flex; align-items:center; gap:8px; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06); min-width: 140px; }
  .lang-select .caret { opacity:0.8; }
  .lang-select .flag.placeholder { opacity: 0; }
  .lang-menu { position:absolute; right:16px; top: calc(100% + 8px); background:#0E1520; color:#fff; border:1px solid rgba(255,255,255,0.16); border-radius:12px; padding:8px; z-index:21000; box-shadow:0 16px 36px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.04); min-width:200px; }
  .lang-menu[hidden]{ display:none; }
  .lang-menu.dropup { top: auto; bottom: calc(100% + 8px); }
  .lang-menu button { width:100%; text-align:left; background:#142132; color:#fff; border:1px solid rgba(255,255,255,0.12); border-radius:10px; padding:8px 10px; margin:4px 0; font-weight:800; display:flex; align-items:center; gap:10px; cursor:pointer; }
  .lang-menu button:hover { background:#1B2B42; }
  </style>
</head>
<body class="site-gradient">
  <div style="position:fixed;top:8px;right:12px;z-index:20050">
    <select id="langSelect" aria-label="Language"></select>
  </div>
  <div class="step2-header">
    <div class="trip-title" id="s2TripTitle">&nbsp;</div>
    <div class="trip-desc" id="s2TripDesc">&nbsp;</div>
  <div class="step-indicator" style="margin-top:14px;color:var(--color-gold,#d9b85f);font-weight:700;opacity:.9" data-i18n="booking.step2_of3">Βήμα 2 από 3</div>
  </div>

  <!-- Centered dark panel like Step 1 calendar host (empty for now) -->
  <div class="step2-band" aria-hidden="true">
    <div class="step2-card"></div>
  </div>

  <!-- Adults / Children counters -->
  <div class="s2-fields" role="group" data-i18n-aria="booking.traveler_options">
    <div class="s2-row">
      <div class="s2-labels">
        <div class="title" data-i18n="booking.adults">Ενήλικες</div>
      </div>
      <div class="s2-counter">
        <button class="btn-round" id="adultsDec" data-i18n-aria="booking.decrease_adults">−</button>
        <div class="count" id="adultsCount">2</div>
        <button class="btn-round" id="adultsInc" data-i18n-aria="booking.increase_adults">+</button>
      </div>
    </div>
    <div class="s2-row">
      <div class="s2-labels">
        <div class="title" data-i18n="booking.children">Παιδιά</div>
        <div class="sub" data-i18n="booking.children_age_range">0 – 17 ετών</div>
      </div>
      <div class="s2-ages" id="childrenAges"><span class="hint" data-i18n="booking.pick_ages">Επιλέξτε ηλικίες</span></div>
      <div class="s2-counter">
        <button class="btn-round" id="childrenDec" data-i18n-aria="booking.decrease_children">−</button>
        <div class="count" id="childrenCount">0</div>
        <button class="btn-round" id="childrenInc" data-i18n-aria="booking.increase_children">+</button>
      </div>
      <!-- Popover age picker -->
      <div class="age-picker" id="agePicker" hidden></div>
    </div>

    <!-- Luggage: Large -->
    <div class="s2-row">
      <div class="s2-labels">
        <div class="title" data-i18n="booking.bags_large">Βαλίτσες (Μεγάλες)</div>
      </div>
      <div class="s2-ages" id="largeBagsText"></div>
      <div class="s2-counter">
        <button class="btn-round" id="largeBagsDec" data-i18n-aria="booking.decrease_bags_large">−</button>
        <div class="count" id="largeBagsCount">0</div>
        <button class="btn-round" id="largeBagsInc" data-i18n-aria="booking.increase_bags_large">+</button>
      </div>
    </div>

    <!-- Luggage: Small -->
    <div class="s2-row">
      <div class="s2-labels">
        <div class="title" data-i18n="booking.bags_small">Βαλίτσες (Μικρές)</div>
      </div>
      <div class="s2-ages" id="smallBagsText"></div>
      <div class="s2-counter">
        <button class="btn-round" id="smallBagsDec" data-i18n-aria="booking.decrease_bags_small">−</button>
        <div class="count" id="smallBagsCount">0</div>
        <button class="btn-round" id="smallBagsInc" data-i18n-aria="booking.increase_bags_small">+</button>
      </div>
    </div>

    <!-- Traveler Profile: Language -->
    <div class="s2-row" id="travelerLanguageRow">
      <div class="s2-labels">
        <div class="title" data-i18n="booking.preferred_language">Γλώσσα επικοινωνίας</div>
      </div>
      <div class="s2-ages"></div>
      <div class="s2-right">
        <button type="button" class="lang-select" id="langSelectBtn">
          <span class="flag">🇬🇷</span>
          <span class="label">Ελληνικά</span>
          <span class="caret">▾</span>
        </button>
      </div>
      <div class="lang-menu" id="langMenu" hidden>
        <button type="button" data-code="el"><span>🇬🇷</span><span data-i18n="booking.preferred_language_options.el">Ελληνικά</span></button>
        <button type="button" data-code="en"><span>🇬🇧</span><span data-i18n="booking.preferred_language_options.en">English</span></button>
        <button type="button" data-code="fr"><span>🇫🇷</span><span data-i18n="booking.preferred_language_options.fr">Français</span></button>
        <button type="button" data-code="de"><span>🇩🇪</span><span data-i18n="booking.preferred_language_options.de">Deutsch</span></button>
        <button type="button" data-code="it"><span>🇮🇹</span><span data-i18n="booking.preferred_language_options.it">Italiano</span></button>
        <button type="button" data-code="es"><span>🇪🇸</span><span data-i18n="booking.preferred_language_options.es">Español</span></button>
        <button type="button" data-code="zh"><span>🇨🇳</span><span data-i18n="booking.preferred_language_options.zh">中文</span></button>
        <button type="button" data-code="he"><span>🇮🇱</span><span data-i18n="booking.preferred_language_options.he">עברית</span></button>
        <button type="button" data-code="nl"><span>🇳🇱</span><span data-i18n="booking.preferred_language_options.nl">Nederlands</span></button>
        <button type="button" data-code="sv"><span>🇸🇪</span><span data-i18n="booking.preferred_language_options.sv">Svenska</span></button>
        <button type="button" data-code="ko"><span>🇰🇷</span><span data-i18n="booking.preferred_language_options.ko">한국어</span></button>
        <button type="button" data-code="pt"><span>🇵🇹</span><span data-i18n="booking.preferred_language_options.pt">Português</span></button>
        <button type="button" data-code="ru"><span>🇷🇺</span><span data-i18n="booking.preferred_language_options.ru">Русский</span></button>
      </div>
    </div>

    <!-- Age Group -->
    <div class="s2-row" id="ageGroupRow">
      <div class="s2-labels">
        <div class="title" data-i18n="booking.age_group">Ηλικιακή ομάδα</div>
      </div>
      <div class="s2-ages"></div>
      <div class="s2-right">
        <button type="button" class="lang-select" id="ageSelectBtn">
          <span class="flag placeholder">🇬🇷</span>
          <span class="label" data-i18n="ui.choose">Επιλέξτε</span>
          <span class="caret">▾</span>
        </button>
      </div>
      <div class="lang-menu" id="ageMenu" hidden>
        <button type="button" data-code="20-30"><span>👤</span><span>20–30</span></button>
        <button type="button" data-code="30-40"><span>👤</span><span>30–40</span></button>
        <button type="button" data-code="40-55"><span>👤</span><span>40–55</span></button>
        <button type="button" data-code="55+"><span>👤</span><span>55+</span></button>
      </div>
    </div>

    <!-- Traveler Type -->
    <div class="s2-row" id="travTypeRow">
      <div class="s2-labels">
        <div class="title" data-i18n="booking.traveler_type">Τύπος ταξιδιώτη</div>
      </div>
      <div class="s2-ages"></div>
      <div class="s2-right">
        <button type="button" class="lang-select" id="travTypeSelectBtn">
          <span class="flag placeholder">🏷️</span>
          <span class="label" data-i18n="ui.choose">Επιλέξτε</span>
          <span class="caret">▾</span>
        </button>
      </div>
      <div class="lang-menu" id="travTypeMenu" hidden>
        <button type="button" data-code="explore"><span>🧭</span><span data-i18n="booking.traveler_type_options.explore">Εξερευνητές – δραστήριοι</span></button>
        <button type="button" data-code="relax"><span>🧘</span><span data-i18n="booking.traveler_type_options.relax">Χαλαροί ταξιδιώτες</span></button>
        <button type="button" data-code="family"><span>👨‍👩‍👧</span><span data-i18n="booking.traveler_type_options.family">Οικογενειακό ύφος</span></button>
        <button type="button" data-code="solo"><span>🧍</span><span data-i18n="booking.traveler_type_options.solo">Μοναχικοί ταξιδιώτες</span></button>
      </div>
    </div>

    <!-- Interests -->
    <div class="s2-row" id="interestsRow">
      <div class="s2-labels">
        <div class="title" data-i18n="booking.interests">Ενδιαφέροντα</div>
      </div>
      <div class="s2-ages"></div>
      <div class="s2-right">
        <button type="button" class="lang-select" id="interestSelectBtn">
          <span class="flag placeholder">🏷️</span>
          <span class="label" data-i18n="ui.choose">Επιλέξτε</span>
          <span class="caret">▾</span>
        </button>
      </div>
      <div class="lang-menu" id="interestMenu" hidden>
        <button type="button" data-code="nature"><span>🌿</span><span data-i18n="booking.interests_options.nature">Φύση</span></button>
        <button type="button" data-code="culture"><span>🏛️</span><span data-i18n="booking.interests_options.culture">Πολιτισμός</span></button>
        <button type="button" data-code="mountain"><span>⛰️</span><span data-i18n="booking.interests_options.mountain">Βουνό</span></button>
        <button type="button" data-code="sea"><span>🌊</span><span data-i18n="booking.interests_options.sea">Θάλασσα</span></button>
        <button type="button" data-code="gastronomy"><span>🍽️</span><span data-i18n="booking.interests_options.gastronomy">Γαστρονομία</span></button>
      </div>
    </div>

    <!-- Sociality -->
    <div class="s2-row" id="socialityRow">
      <div class="s2-labels">
        <div class="title" data-i18n="booking.sociality">Κοινωνικότητα</div>
      </div>
      <div class="s2-ages"></div>
      <div class="s2-right">
        <button type="button" class="lang-select" id="socialSelectBtn">
          <span class="flag placeholder">🏷️</span>
          <span class="label" data-i18n="ui.choose">Επιλέξτε</span>
          <span class="caret">▾</span>
        </button>
      </div>
      <div class="lang-menu" id="socialMenu" hidden>
        <button type="button" data-code="social"><span>😊</span><span data-i18n="booking.sociality_options.social">Κοινωνικός</span></button>
        <button type="button" data-code="quiet"><span>🤫</span><span data-i18n="booking.sociality_options.quiet">Ήσυχος</span></button>
      </div>
    </div>
  </div>

  <!-- Bottom actions like Step 1 -->
  <div class="s2-actions">
    <button id="s2Back" class="btn" data-i18n="ui.back">Πίσω</button>
    <button id="s2Next" class="btn" data-i18n="booking.next">Επόμενο</button>
  </div>

  <!-- Overlays: About, AI Assistant, Profile -->
  <div id="aboutOverlay" class="overlay" role="dialog" aria-modal="true" hidden>
    <button class="close-overlay" onclick="closeOverlay('aboutOverlay')" data-i18n-aria="ui.close">×</button>
    <div class="overlay-inner">
      <h2 data-i18n="about.title">Σχετικά με εμάς</h2>
      <p data-i18n="about.text">Το Greekaway δημιουργήθηκε για να σας προσφέρει επιλεγμένες εκδρομές στην Ελλάδα με άνεση, τεχνολογία και στυλ.</p>
    </div>
  </div>

  <div id="aiOverlay" class="overlay" role="dialog" aria-modal="true" hidden>
    <button class="close-overlay" onclick="closeOverlay('aiOverlay')" data-i18n-aria="ui.close">×</button>
    <div class="overlay-inner">
      <h2 data-i18n="nav.ai">Βοηθός AI</h2>
      <p data-i18n="welcome.ask">Ρωτήστε μας ό,τι θέλετε για την εκδρομή σας!</p>
    </div>
  </div>

  <div id="profileOverlay" class="overlay" role="dialog" aria-modal="true" hidden>
    <button class="close-overlay" onclick="closeOverlay('profileOverlay')" data-i18n-aria="ui.close">×</button>
    <div class="overlay-inner">
      <h2 data-i18n="nav.profile">Το Προφίλ μου</h2>
      <p data-i18n="profile.info">Εδώ θα δείτε τις εκδρομές που έχετε κάνει και τις κρατήσεις σας.</p>
    </div>
  </div>

  <!-- Shared footer -->
  <footer>
    <a href="/index.html">
      <i class="fas fa-home"></i>
      <span data-i18n="nav.home">Home</span>
    </a>

    <a href="javascript:void(0)" onclick="openOverlay('aboutOverlay')">
      <i class="fas fa-info-circle"></i>
      <span data-i18n="nav.about">About Us</span>
    </a>

    <a href="javascript:void(0)" class="central-btn">
      <i class="fas fa-bell"></i>
      <span data-i18n="nav.book">Κράτηση</span>
    </a>

    <a href="javascript:void(0)" onclick="openOverlay('aiOverlay')">
      <i class="fas fa-comments"></i>
      <span data-i18n="nav.ai">AI Assistant</span>
    </a>

    <a href="javascript:void(0)" onclick="openOverlay('profileOverlay')">
      <i class="fas fa-user"></i>
      <span data-i18n="nav.profile">Προφίλ</span>
    </a>
  </footer>
  <!-- Optional: overlays can be added later if needed -->
  <!-- Load i18n first so translations are ready before other logic; add cache-busting -->
  <script src="/js/i18n.js?v=20251022" defer></script>
  <script src="/js/overlay-manager.js?v=2" defer></script>
  <script src="/js/assistant.js?v=2" defer></script>
  <script>
    // Optional: lightweight behaviour — Πίσω γυρίζει στην προηγούμενη σελίδα
    try { document.getElementById('s2Back').addEventListener('click', () => history.back()); } catch(_){ }
    // Populate header from sessionStorage (set in Step 1)
    (function() {
      const headerEl = document.querySelector('.step2-header');
      const titleEl = document.getElementById('s2TripTitle');
      const descEl = document.getElementById('s2TripDesc');
      try {
        const t = sessionStorage.getItem('gw_trip_title') || '';
        const d = sessionStorage.getItem('gw_trip_desc') || '';
        const id = sessionStorage.getItem('gw_trip_id') || '';
        if (t) {
          titleEl.textContent = t;
        } else if (id) {
          // fetch trip json and localize based on current UI lang (or stored gw_lang)
          (async function(){
            try {
              const lang = (localStorage.getItem('gw_lang') || 'el');
              // get data version
              let dv = '';
              try { const rv = await fetch('/version.json', { cache: 'no-cache' }); if (rv.ok) { const j = await rv.json(); dv = j && j.dataVersion ? ('?v='+encodeURIComponent(String(j.dataVersion))) : ''; } } catch(_){ }
              const r = await fetch(`/data/trips/${encodeURIComponent(id)}.json${dv}`, { cache: 'no-cache' });
              if (!r.ok) return;
              const trip = await r.json();
              const getLocalized = (field) => {
                if (!field) return '';
                if (typeof field === 'string') return field;
                if (typeof field === 'object') return field[lang] || field['el'] || Object.values(field)[0] || '';
                return '';
              };
              const title = getLocalized(trip.title);
              const desc = getLocalized(trip.description);
              // cache loaded trip so i18n:changed can re-render it
              try { window.__loadedTrip = trip; } catch(_){ }
              if (title) titleEl.textContent = title;
              if (desc) descEl.textContent = desc;
            } catch(_){ }
          })();
        }
        if (!t && !d && !id && headerEl) headerEl.style.display = 'none';
      } catch(_) {
        if (headerEl) headerEl.style.display = 'none';
      }
    })();

    // Simple counters logic (limits: adults 1..10, children 0..10)
    (function(){
        // Safe i18n accessor to avoid rendering raw keys before i18n is ready
        function tSafe(key, fallback){
          try { const v = (window.t && window.t(key)) || ''; return (v && v !== key) ? v : fallback; } catch(_){ return fallback; }
        }
      const adultsCount = document.getElementById('adultsCount');
      const childrenCount = document.getElementById('childrenCount');
      const childrenAgesEl = document.getElementById('childrenAges');
      const agePicker = document.getElementById('agePicker');
      const ages = [];
      const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
      const getN = (el) => parseInt((el && el.textContent) || '0', 10) || 0;
      const setN = (el, n) => { if (el) el.textContent = String(n); };
      const renderAges = () => {
        if (!childrenAgesEl) return;
        if (ages.length === 0) {
          // Show translatable hint; fallback if t() not ready
          const hint = (window.t ? window.t('booking.pick_ages') : 'Επιλέξτε ηλικίες');
          childrenAgesEl.innerHTML = '<span class="hint" data-i18n="booking.pick_ages"></span>';
          // Also set immediate text for UX
          const span = childrenAgesEl.querySelector('.hint');
          if (span) span.textContent = hint;
        } else {
          childrenAgesEl.textContent = ages.join(', ');
        }
      };
      const openPicker = () => {
        if (!agePicker) return;
        if (ages.length >= 10) return; // respect max children
        if (agePicker.childElementCount === 0) {
          for (let i=1; i<=17; i++) {
            const b = document.createElement('button');
            b.type = 'button'; b.textContent = String(i);
            b.addEventListener('click', ()=>{
              if (ages.length < 10) {
                ages.push(i);
                setN(childrenCount, ages.length);
                renderAges();
              }
              closePicker();
            });
            agePicker.appendChild(b);
          }
        }
        agePicker.hidden = false;
        // decide drop direction
        const row = agePicker.closest('.s2-row');
        if (row) {
          const rect = row.getBoundingClientRect();
          const spaceBelow = window.innerHeight - rect.bottom;
          agePicker.classList.toggle('dropup', spaceBelow < 260);
        }
        setTimeout(()=>{
          const onDoc = (ev) => {
            if (!agePicker.contains(ev.target)) { closePicker(); document.removeEventListener('click', onDoc); }
          };
          document.addEventListener('click', onDoc);
        },0);
      };
      const closePicker = () => { if (agePicker) agePicker.hidden = true; };

  document.getElementById('adultsDec')?.addEventListener('click', ()=>{ const n=clamp(getN(adultsCount)-1,1,10); setN(adultsCount,n); });
  document.getElementById('adultsInc')?.addEventListener('click', ()=>{ const n=clamp(getN(adultsCount)+1,1,10); setN(adultsCount,n); });
      document.getElementById('childrenDec')?.addEventListener('click', ()=>{
        if (ages.length > 0) { ages.pop(); setN(childrenCount, ages.length); renderAges(); }
        else { const n=clamp(getN(childrenCount)-1,0,10); setN(childrenCount,n); }
      });
      document.getElementById('childrenInc')?.addEventListener('click', (e)=>{
        e.stopPropagation();
        openPicker();
      });
      renderAges();

      // Luggage counters (0..10 each)
      const largeBagsCount = document.getElementById('largeBagsCount');
      const smallBagsCount = document.getElementById('smallBagsCount');
      const largeBagsText = document.getElementById('largeBagsText');
      const smallBagsText = document.getElementById('smallBagsText');
      const renderBags = () => {
        if (largeBagsText) largeBagsText.textContent = getN(largeBagsCount) ? '' : '';
        if (smallBagsText) smallBagsText.textContent = getN(smallBagsCount) ? '' : '';
      };
      document.getElementById('largeBagsDec')?.addEventListener('click', ()=>{ const n=clamp(getN(largeBagsCount)-1,0,10); setN(largeBagsCount,n); renderBags(); });
      document.getElementById('largeBagsInc')?.addEventListener('click', ()=>{ const n=clamp(getN(largeBagsCount)+1,0,10); setN(largeBagsCount,n); renderBags(); });
      document.getElementById('smallBagsDec')?.addEventListener('click', ()=>{ const n=clamp(getN(smallBagsCount)-1,0,10); setN(smallBagsCount,n); renderBags(); });
      document.getElementById('smallBagsInc')?.addEventListener('click', ()=>{ const n=clamp(getN(smallBagsCount)+1,0,10); setN(smallBagsCount,n); renderBags(); });

      // Language selector
      const langBtn = document.getElementById('langSelectBtn');
      const langMenu = document.getElementById('langMenu');
      // Set ONLY the preferred communication language (do NOT change global UI)
      const setLang = (code, label, flag) => {
        langBtn?.querySelector('.label')?.replaceChildren(document.createTextNode(label));
        langBtn?.querySelector('.flag')?.replaceChildren(document.createTextNode(flag));
        // Persist under gw_pref_lang so it won't affect global UI language
        try { sessionStorage.setItem('gw_pref_lang', code); } catch(_){ }
        try { localStorage.setItem('gw_pref_lang', code); } catch(_){ }
      };
      // Initial preferred value: previously chosen preference, or fall back to current UI language
      const defaultLang = (()=>{ 
        try {
          return sessionStorage.getItem('gw_pref_lang') || localStorage.getItem('gw_pref_lang') || localStorage.getItem('gw_lang') || sessionStorage.getItem('gw_lang') || 'el';
        } catch(_){ return 'el'; }
      })();
  const langFlags = { el:'🇬🇷', en:'🇬🇧', fr:'🇫🇷', de:'🇩🇪', it:'🇮🇹', es:'🇪🇸', zh:'🇨🇳', he:'🇮🇱', nl:'��🇱', sv:'🇸🇪', ko:'🇰🇷', pt:'🇵🇹', ru:'🇷🇺' };
  const langFallbackLabels = { el:'Ελληνικά', en:'English', fr:'Français', de:'Deutsch', it:'Italiano', es:'Español', zh:'中文', he:'עברית', nl:'Nederlands', sv:'Svenska', ko:'한국어', pt:'Português', ru:'Русский' };
      {
    const label = tSafe('booking.preferred_language_options.' + defaultLang, (langFallbackLabels[defaultLang] || defaultLang.toUpperCase()));
        const flag = langFlags[defaultLang] || '';
        setLang(defaultLang, label, flag);
      }
  langBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); if (langMenu) { langMenu.hidden = !langMenu.hidden; if (!langMenu.hidden) { const row = langMenu.closest('.s2-row'); if (row) { const rect = row.getBoundingClientRect(); const spaceBelow = window.innerHeight - rect.bottom; langMenu.classList.toggle('dropup', spaceBelow < 220); } } } });
      langMenu?.querySelectorAll('button')?.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const code = btn.getAttribute('data-code') || 'el';
          const label = tSafe('booking.preferred_language_options.' + code, (langFallbackLabels[code] || code.toUpperCase()));
          const flag = langFlags[code] || '';
          setLang(code, label, flag);
          if (langMenu) langMenu.hidden = true;
        });
      });
      document.addEventListener('click', (e)=>{
        if (langMenu && !langMenu.hidden && !langMenu.contains(e.target) && e.target !== langBtn) langMenu.hidden = true;
      });

      // Age group selector
      const ageBtn = document.getElementById('ageSelectBtn');
      const ageMenu = document.getElementById('ageMenu');
      const setAgeGroup = (code, label) => {
        const lblEl = ageBtn?.querySelector('.label');
        lblEl?.replaceChildren(document.createTextNode(label));
        // Prevent i18n auto-apply from reverting to "Choose"
        lblEl?.removeAttribute('data-i18n');
        try { sessionStorage.setItem('gw_age_group', code); } catch(_){ }
      };
  const ageMap = { '20-30':'20–30', '30-40':'30–40', '40-55':'40–55', '55+':'55+' };
      const defaultAge = (()=>{ try { return sessionStorage.getItem('gw_age_group') || ''; } catch(_){ return ''; } })();
      if (defaultAge && ageMap[defaultAge]) setAgeGroup(defaultAge, ageMap[defaultAge]);
  ageBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); if (ageMenu) { ageMenu.hidden = !ageMenu.hidden; if (!ageMenu.hidden) { const row = ageMenu.closest('.s2-row'); if (row) { const rect = row.getBoundingClientRect(); const spaceBelow = window.innerHeight - rect.bottom; ageMenu.classList.toggle('dropup', spaceBelow < 220); } } } });
      ageMenu?.querySelectorAll('button')?.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const code = btn.getAttribute('data-code') || '';
          const label = ageMap[code] || 'Επιλέξτε';
          setAgeGroup(code, label);
          if (ageMenu) ageMenu.hidden = true;
        });
      });
      document.addEventListener('click', (e)=>{
        if (ageMenu && !ageMenu.hidden && !ageMenu.contains(e.target) && e.target !== ageBtn) ageMenu.hidden = true;
      });

      // Traveler type selector
      const travTypeBtn = document.getElementById('travTypeSelectBtn');
      const travTypeMenu = document.getElementById('travTypeMenu');
      const travTypeFallback = {
        explore: 'Εξερευνητές – δραστήριοι',
        relax: 'Χαλαροί ταξιδιώτες',
        family: 'Οικογενειακό ύφος',
        solo: 'Μοναχικοί ταξιδιώτες'
      };
      const setTravType = (code) => {
        const label = (code ? (window.t ? window.t('booking.traveler_type_options.' + code) : (travTypeFallback[code] || 'Επιλέξτε')) : 'Επιλέξτε');
        const lblEl = travTypeBtn?.querySelector('.label');
        lblEl?.replaceChildren(document.createTextNode(label));
        lblEl?.removeAttribute('data-i18n');
        try { sessionStorage.setItem('gw_traveler_type', code); } catch(_){ }
      };
      const defaultTravType = (()=>{ try { return sessionStorage.getItem('gw_traveler_type') || ''; } catch(_){ return ''; } })();
      if (defaultTravType) setTravType(defaultTravType);
  travTypeBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); if (travTypeMenu) { travTypeMenu.hidden = !travTypeMenu.hidden; if (!travTypeMenu.hidden) { const row = travTypeMenu.closest('.s2-row'); if (row) { const rect = row.getBoundingClientRect(); const spaceBelow = window.innerHeight - rect.bottom; travTypeMenu.classList.toggle('dropup', spaceBelow < 220); } } } });
      travTypeMenu?.querySelectorAll('button')?.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const code = btn.getAttribute('data-code') || '';
          setTravType(code);
          if (travTypeMenu) travTypeMenu.hidden = true;
        });
      });
      document.addEventListener('click', (e)=>{
        if (travTypeMenu && !travTypeMenu.hidden && !travTypeMenu.contains(e.target) && e.target !== travTypeBtn) travTypeMenu.hidden = true;
      });

      // Interests selector
      const interestBtn = document.getElementById('interestSelectBtn');
      const interestMenu = document.getElementById('interestMenu');
      const interestFallback = {
        nature: 'Φύση',
        culture: 'Πολιτισμός',
        mountain: 'Βουνό',
        sea: 'Θάλασσα',
        gastronomy: 'Γαστρονομία'
      };
      const setInterest = (code) => {
        const label = (code ? (window.t ? window.t('booking.interests_options.' + code) : (interestFallback[code] || 'Επιλέξτε')) : 'Επιλέξτε');
        const lblEl = interestBtn?.querySelector('.label');
        lblEl?.replaceChildren(document.createTextNode(label));
        lblEl?.removeAttribute('data-i18n');
        try { sessionStorage.setItem('gw_interest', code); } catch(_){ }
      };
      const defaultInterest = (()=>{ try { return sessionStorage.getItem('gw_interest') || ''; } catch(_){ return ''; } })();
      if (defaultInterest) setInterest(defaultInterest);
  interestBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); if (interestMenu) { interestMenu.hidden = !interestMenu.hidden; if (!interestMenu.hidden) { const row = interestMenu.closest('.s2-row'); if (row) { const rect = row.getBoundingClientRect(); const spaceBelow = window.innerHeight - rect.bottom; interestMenu.classList.toggle('dropup', spaceBelow < 220); } } } });
      interestMenu?.querySelectorAll('button')?.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const code = btn.getAttribute('data-code') || '';
          setInterest(code);
          if (interestMenu) interestMenu.hidden = true;
        });
      });
      document.addEventListener('click', (e)=>{
        if (interestMenu && !interestMenu.hidden && !interestMenu.contains(e.target) && e.target !== interestBtn) interestMenu.hidden = true;
      });

      // Sociality selector
      const socialBtn = document.getElementById('socialSelectBtn');
      const socialMenu = document.getElementById('socialMenu');
      const socialFallback = { social: 'Κοινωνικός', quiet: 'Ήσυχος' };
      const setSocial = (code) => {
        const label = (code ? (window.t ? window.t('booking.sociality_options.' + code) : (socialFallback[code] || 'Επιλέξτε')) : 'Επιλέξτε');
        const lblEl = socialBtn?.querySelector('.label');
        lblEl?.replaceChildren(document.createTextNode(label));
        lblEl?.removeAttribute('data-i18n');
        try { sessionStorage.setItem('gw_sociality', code); } catch(_){ }
      };
      const defaultSocial = (()=>{ try { return sessionStorage.getItem('gw_sociality') || ''; } catch(_){ return ''; } })();
      if (defaultSocial) setSocial(defaultSocial);
  socialBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); if (socialMenu) { socialMenu.hidden = !socialMenu.hidden; if (!socialMenu.hidden) { const row = socialMenu.closest('.s2-row'); if (row) { const rect = row.getBoundingClientRect(); const spaceBelow = window.innerHeight - rect.bottom; socialMenu.classList.toggle('dropup', spaceBelow < 220); } } } });
      socialMenu?.querySelectorAll('button')?.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const code = btn.getAttribute('data-code') || '';
          setSocial(code);
          if (socialMenu) socialMenu.hidden = true;
        });
      });
      document.addEventListener('click', (e)=>{
        if (socialMenu && !socialMenu.hidden && !socialMenu.contains(e.target) && e.target !== socialBtn) socialMenu.hidden = true;
      });

      // Persist all values on Next and go to Step 3
      document.getElementById('s2Next')?.addEventListener('click', (ev)=>{
        try { ev.preventDefault(); } catch(_){ }
        try {
          // adults
          sessionStorage.setItem('gw_adults', String(getN(adultsCount)));
          // children ages
          sessionStorage.setItem('gw_children_ages', JSON.stringify(ages));
          // bags
          sessionStorage.setItem('gw_bags_large', String(getN(document.getElementById('largeBagsCount'))));
          sessionStorage.setItem('gw_bags_small', String(getN(document.getElementById('smallBagsCount'))));
        } catch(_){}
        try {
          const origin = (window.location && window.location.origin) || (window.location.protocol + '//' + window.location.host) || '';
          const absUrl = origin ? (new URL('/step3.html', origin).href) : '/step3.html';
          try { window.location.assign(absUrl); }
          catch(_e1){ try { window.location.href = absUrl; } catch(_e2){ setTimeout(()=>{ window.location.href = '/step3.html'; }, 0); } }
        } catch(_){ window.location.href = '/step3.html'; }
      });
      // Re-apply selected labels when language changes
      try {
        window.addEventListener('i18n:changed', () => {
          try {
            // Keep showing the chosen communication language, but translate its label in current UI language
            const curPref = (sessionStorage.getItem('gw_pref_lang') || localStorage.getItem('gw_pref_lang') || defaultLang);
            const label = (window.t ? window.t('booking.preferred_language_options.' + curPref) : (langFallbackLabels[curPref] || curPref.toUpperCase()));
            const flag = langFlags[curPref] || '';
            langBtn?.querySelector('.label')?.replaceChildren(document.createTextNode(label));
            langBtn?.querySelector('.flag')?.replaceChildren(document.createTextNode(flag));
          } catch(_){ }

          try {
            const curTrav = sessionStorage.getItem('gw_traveler_type') || '';
            if (curTrav) setTravType(curTrav);
          } catch(_){ }
          try {
            const curInterest = sessionStorage.getItem('gw_interest') || '';
            if (curInterest) setInterest(curInterest);
          } catch(_){ }
          try {
            const curSocial = sessionStorage.getItem('gw_sociality') || '';
            if (curSocial) setSocial(curSocial);
          } catch(_){ }
          try {
            const curAge = sessionStorage.getItem('gw_age_group') || '';
            if (curAge) setAgeGroup(curAge, (ageMap[curAge] || ''));
          } catch(_){ }
          // Ages hint may need re-translation
          try { renderAges(); } catch(_){ }
          // Re-render trip title/description if we have cached trip JSON
          try {
            const t = window.__loadedTrip || null;
            if (t) {
              const lang = (window.currentI18n && window.currentI18n.lang) || localStorage.getItem('gw_lang') || 'el';
              const getLocalized = (field) => {
                if (!field) return '';
                if (typeof field === 'string') return field;
                if (typeof field === 'object') return field[lang] || field['el'] || Object.values(field)[0] || '';
                return '';
              };
              const title = getLocalized(t.title);
              const desc = getLocalized(t.description);
              if (title) titleEl.textContent = title;
              if (desc) descEl.textContent = desc;
            }
          } catch(_){ }
        });
      } catch(_){ }
    })();
    // Ensure translations apply after DOM is fully ready (covers any early t() fallback rendering)
    document.addEventListener('DOMContentLoaded', function(){
      try { if (window.currentI18n && window.setLanguage) window.setLanguage(window.currentI18n.lang); } catch(_){ }
      try { setTimeout(() => { if (window.currentI18n && window.setLanguage) window.setLanguage(window.currentI18n.lang); }, 60); } catch(_){ }
    });
  </script>
</body>
</html>
