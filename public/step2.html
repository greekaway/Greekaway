<!DOCTYPE html>
<html lang="el" class="booking-step2-root">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Greekaway â€“ Î’Î®Î¼Î± 2</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <!-- Unified footer: keep single injection via footer.js; prevent double load by adding id -->
  <link id="ga-footer-rounded-css" rel="stylesheet" href="/css/footer-rounded.css">
  <link rel="stylesheet" href="/css/theme.css">
  <link rel="stylesheet" href="/css/step2.css">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1B2A3A">
  <link rel="stylesheet" href="/pwa.css">
  <link rel="stylesheet" href="/css/pwa-fixes.css">
</head>
<body class="booking-step booking-step2">
  <main id="step2Root" class="step2-shell" aria-live="polite">
    <header class="step2-head step2-header">
      <div class="step-head-top">
        <div class="step-chip" data-i18n="booking.step2_of3">Î’Î®Î¼Î± 2 Î±Ï€ÏŒ 3</div>
        <div id="s2PriceLine" class="price-line">â€”</div>
      </div>
      <h1 id="s2TripTitle">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· ÎµÎºÎ´ÏÎ¿Î¼Î®Ï‚â€¦</h1>
      <div class="step2-meta">
        <span id="s2TripDate" class="meta-pill">â€”</span>
        <span id="s2ModeLabel" class="meta-pill" hidden>â€”</span>
      </div>
      <div id="s2HeadError" class="head-error" hidden></div>
    </header>

    <section class="step2-panels s2-fields" role="group" data-i18n-aria="booking.traveler_options">
      <article class="step2-card" id="passengersCard">
        <div class="card-head">
          <p class="card-kicker">Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Ï„Î±Î¾Î¹Î´Î¹Ï‰Ï„ÏÎ½</p>
          <h2>Î•Ï€Î¹Î²Î¬Ï„ÎµÏ‚ &amp; Î±Ï€Î¿ÏƒÎºÎµÏ…Î­Ï‚</h2>
        </div>
        <div class="card-body">
          <div class="s2-row">
            <div class="s2-labels">
              <div class="title" data-i18n="booking.adults">Î•Î½Î®Î»Î¹ÎºÎµÏ‚</div>
            </div>
            <div class="s2-counter">
              <button class="btn-round" id="adultsDec" data-i18n-aria="booking.decrease_adults">âˆ’</button>
              <div class="count" id="adultsCount">2</div>
              <button class="btn-round" id="adultsInc" data-i18n-aria="booking.increase_adults">+</button>
            </div>
          </div>
          <div class="s2-row">
            <div class="s2-labels">
              <div class="title" data-i18n="booking.children">Î Î±Î¹Î´Î¹Î¬</div>
              <div class="sub" data-i18n="booking.children_age_range">0 â€“ 17 ÎµÏ„ÏÎ½</div>
            </div>
            <div class="s2-ages" id="childrenAges"><span class="hint" data-i18n="booking.pick_ages">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î·Î»Î¹ÎºÎ¯ÎµÏ‚</span></div>
            <div class="s2-counter">
              <button class="btn-round" id="childrenDec" data-i18n-aria="booking.decrease_children">âˆ’</button>
              <div class="count" id="childrenCount">0</div>
              <button class="btn-round" id="childrenInc" data-i18n-aria="booking.increase_children">+</button>
            </div>
            <div class="age-picker" id="agePicker" hidden></div>
          </div>
          <div class="s2-row" id="suitcasesRow">
            <div class="s2-labels">
              <div class="title" data-i18n="booking.suitcases">Î‘Ï€Î¿ÏƒÎºÎµÏ…Î­Ï‚</div>
              <div class="sub" id="suitcaseSummary">â€”</div>
            </div>
            <div class="s2-counter">
              <button class="btn-round" id="suitcasesDec" aria-label="âˆ’">âˆ’</button>
              <div class="count" id="suitcasesCount">0</div>
              <button class="btn-round" id="suitcasesInc" aria-label="+">+</button>
            </div>
          </div>
          <div class="seat-limit-notice" id="seatLimitNotice" hidden>
            <div class="seat-limit-chip" id="seatLimitMessage">â€”</div>
          </div>
          <div class="field-inline-error" id="seatLimitError" hidden></div>
        </div>
      </article>

      <article class="step2-card" id="pickupCard">
        <div class="card-head">
          <p class="card-kicker">Î£Î·Î¼ÎµÎ¯Î¿ Ï€Î±ÏÎ±Î»Î±Î²Î®Ï‚</p>
          <h2>Î Î±ÏÎ±Î»Î±Î²Î® &amp; ÏƒÏ„Î¬ÏƒÎµÎ¹Ï‚</h2>
          <p class="card-sub">Î”ÏÏƒÎµ Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· ÎºÎ±Î¹ ÎµÏ€Î­Î»ÎµÎ¾Îµ ÏƒÏ„Î¬ÏƒÎ· Î»ÎµÏ‰Ï†Î¿ÏÎµÎ¯Î¿Ï… (Î±Î½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹).</p>
        </div>
        <div class="card-body">
          <div class="s2-row pickup-required" id="pickupRow">
            <div class="s2-labels">
              <label for="pickupInput" id="pickupLabel" class="title" data-i18n="booking.pickup_location">Î£Î·Î¼ÎµÎ¯Î¿ Î Î±ÏÎ±Î»Î±Î²Î®Ï‚</label>
            </div>
            <div class="s2-input-group pickup-reordered">
              <button type="button" id="pickupMapBtn" class="s2-map-btn" title="Î§Î¬ÏÏ„Î·Ï‚" data-i18n-title="booking.map_btn_title" aria-label="Î§Î¬ÏÏ„Î·Ï‚">
                <i class="fa-solid fa-map-pin icon" aria-hidden="true"></i>
              </button>
              <input type="text" id="pickupInput" class="s2-input" data-i18n-placeholder="booking.pickup_placeholder" placeholder="Î‘ÏÏ‡Î¯ÏƒÏ„Îµ Î½Î± Ï€Î»Î·ÎºÏ„ÏÎ¿Î»Î¿Î³ÎµÎ¯Ï„Îµ Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·" autocomplete="off" />
            </div>
            <div class="places-dropdown" id="pickupSuggest" hidden></div>
          </div>

          <div id="busExtrasContainer" class="bus-extras-container" hidden>
            <div class="s2-row bus-suggestion-row" id="busSuggestionRow" hidden>
              <div class="bus-suggestion-label">Î ÏÎ¿Ï„ÎµÎ¹Î½ÏŒÎ¼ÎµÎ½Î· ÏƒÏ„Î¬ÏƒÎ·</div>
              <div class="bus-suggestion-value" id="busSuggestionValue">â€”</div>
            </div>

            <div class="s2-row vertical bus-stops-row" id="busStopsRow" hidden>
              <div class="s2-labels">
                <div class="title">Î£Ï„Î¬ÏƒÎ· Î»ÎµÏ‰Ï†Î¿ÏÎµÎ¯Î¿Ï…</div>
                <div class="sub">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÏƒÎ·Î¼ÎµÎ¯Î¿ ÎµÏ€Î¹Î²Î¯Î²Î±ÏƒÎ·Ï‚</div>
                <div class="field-inline-error" id="busStopError" hidden>Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÏƒÏ„Î¬ÏƒÎ·</div>
              </div>
              <div class="bus-stop-list" id="busStopList" role="radiogroup" aria-label="Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼ÎµÏ‚ ÏƒÏ„Î¬ÏƒÎµÎ¹Ï‚"></div>
            </div>
          </div>

          <div class="s2-row" id="specialRequestsRow">
            <div class="s2-labels">
              <div class="title" data-i18n="booking.driver_message">ÎœÎ®Î½Ï…Î¼Î± ÏƒÏ„Î¿Î½ Î¿Î´Î·Î³ÏŒ</div>
            </div>
            <div class="s2-input-group">
              <textarea id="specialRequests" class="s2-textarea" rows="1" data-i18n-placeholder="booking.driver_message_placeholder" placeholder="ÎœÎ®Î½Ï…Î¼Î± Ï€ÏÎ¿Ï‚ Ï„Î¿Î½ Î¿Î´Î·Î³ÏŒ (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬)"></textarea>
            </div>
          </div>
        </div>
      </article>

      <article class="step2-card" id="profileCard">
        <div class="card-head">
          <p class="card-kicker">Î ÏÎ¿Ï„Î¹Î¼Î®ÏƒÎµÎ¹Ï‚</p>
          <h2>Î ÏÎ¿Ï†Î¯Î» Ï„Î±Î¾Î¹Î´Î¹ÏÏ„Î·</h2>
          <p class="card-sub">Î•Ï€Î­Î»ÎµÎ¾Îµ Î·Î»Î¹ÎºÎ¹Î±ÎºÎ® Î¿Î¼Î¬Î´Î± ÎºÎ±Î¹ ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎ¿Î½Ï„Î± Î³Î¹Î± Ï€Î¹Î¿ ÏƒÏ„Î¿Ï‡ÎµÏ…Î¼Î­Î½ÎµÏ‚ Ï€ÏÎ¿Ï„Î¬ÏƒÎµÎ¹Ï‚.</p>
        </div>
        <div class="card-body">
          <div class="s2-row" id="ageGroupRow">
            <div class="s2-labels">
              <div class="title" id="ageGroupTitle" data-i18n="booking.age_group">Î—Î»Î¹ÎºÎ¹Î±ÎºÎ® Î¿Î¼Î¬Î´Î±</div>
              <div class="field-inline-error" id="ageGroupError" hidden data-i18n="booking.choose_category">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</div>
            </div>
            <div class="s2-ages"></div>
            <div class="s2-right">
              <button type="button" class="lang-select" id="ageSelectBtn">
                <span class="flag placeholder">ğŸ‡¬ğŸ‡·</span>
                <span class="label" data-i18n="ui.choose">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ</span>
                <span class="caret">â–¾</span>
              </button>
            </div>
            <div class="lang-menu" id="ageMenu" hidden>
              <button type="button" data-code="20-30"><span>ğŸ‘¤</span><span>20â€“30</span></button>
              <button type="button" data-code="30-40"><span>ğŸ‘¤</span><span>30â€“40</span></button>
              <button type="button" data-code="40-55"><span>ğŸ‘¤</span><span>40â€“55</span></button>
              <button type="button" data-code="55+"><span>ğŸ‘¤</span><span>55+</span></button>
            </div>
          </div>

          <div class="s2-row" id="travTypeRow">
            <div class="s2-labels">
              <div class="title" id="travTypeTitle" data-i18n="booking.traveler_type">Î¤ÏÏ€Î¿Ï‚ Ï„Î±Î¾Î¹Î´Î¹ÏÏ„Î·</div>
              <div class="field-inline-error" id="travTypeError" hidden data-i18n="booking.choose_category">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</div>
            </div>
            <div class="s2-ages"></div>
            <div class="s2-right">
              <button type="button" class="lang-select" id="travTypeSelectBtn">
                <span class="flag placeholder">ğŸ·ï¸</span>
                <span class="label" data-i18n="ui.choose">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ</span>
                <span class="caret">â–¾</span>
              </button>
            </div>
            <div class="lang-menu" id="travTypeMenu" hidden>
              <button type="button" data-code="explore"><span>ğŸ§­</span><span data-i18n="booking.traveler_type_options.explore">Î•Î¾ÎµÏÎµÏ…Î½Î·Ï„Î­Ï‚ â€“ Î´ÏÎ±ÏƒÏ„Î®ÏÎ¹Î¿Î¹</span></button>
              <button type="button" data-code="relax"><span>ğŸ§˜</span><span data-i18n="booking.traveler_type_options.relax">Î§Î±Î»Î±ÏÎ¿Î¯ Ï„Î±Î¾Î¹Î´Î¹ÏÏ„ÎµÏ‚</span></button>
              <button type="button" data-code="family"><span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span><span data-i18n="booking.traveler_type_options.family">ÎŸÎ¹ÎºÎ¿Î³ÎµÎ½ÎµÎ¹Î±ÎºÏŒ ÏÏ†Î¿Ï‚</span></button>
              <button type="button" data-code="solo"><span>ğŸ§</span><span data-i18n="booking.traveler_type_options.solo">ÎœÎ¿Î½Î±Ï‡Î¹ÎºÎ¿Î¯ Ï„Î±Î¾Î¹Î´Î¹ÏÏ„ÎµÏ‚</span></button>
            </div>
          </div>

          <div class="s2-row" id="interestsRow">
            <div class="s2-labels">
              <div class="title" data-i18n="booking.interests">Î•Î½Î´Î¹Î±Ï†Î­ÏÎ¿Î½Ï„Î±</div>
            </div>
            <div class="s2-ages"></div>
            <div class="s2-right">
              <button type="button" class="lang-select" id="interestSelectBtn">
                <span class="flag placeholder">ğŸ·ï¸</span>
                <span class="label" data-i18n="ui.choose">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ</span>
                <span class="caret">â–¾</span>
              </button>
            </div>
            <div class="lang-menu" id="interestMenu" hidden>
              <button type="button" data-code="nature"><span>ğŸŒ¿</span><span data-i18n="booking.interests_options.nature">Î¦ÏÏƒÎ·</span></button>
              <button type="button" data-code="culture"><span>ğŸ›ï¸</span><span data-i18n="booking.interests_options.culture">Î Î¿Î»Î¹Ï„Î¹ÏƒÎ¼ÏŒÏ‚</span></button>
              <button type="button" data-code="mountain"><span>â›°ï¸</span><span data-i18n="booking.interests_options.mountain">Î’Î¿Ï…Î½ÏŒ</span></button>
              <button type="button" data-code="sea"><span>ğŸŒŠ</span><span data-i18n="booking.interests_options.sea">Î˜Î¬Î»Î±ÏƒÏƒÎ±</span></button>
              <button type="button" data-code="gastronomy"><span>ğŸ½ï¸</span><span data-i18n="booking.interests_options.gastronomy">Î“Î±ÏƒÏ„ÏÎ¿Î½Î¿Î¼Î¯Î±</span></button>
            </div>
          </div>

          <div class="s2-row" id="socialityRow">
            <div class="s2-labels">
              <div class="title" data-i18n="booking.sociality">ÎšÎ¿Î¹Î½Ï‰Î½Î¹ÎºÏŒÏ„Î·Ï„Î±</div>
            </div>
            <div class="s2-ages"></div>
            <div class="s2-right">
              <button type="button" class="lang-select" id="socialSelectBtn">
                <span class="flag placeholder">ğŸ·ï¸</span>
                <span class="label" data-i18n="ui.choose">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ</span>
                <span class="caret">â–¾</span>
              </button>
            </div>
            <div class="lang-menu" id="socialMenu" hidden>
              <button type="button" data-code="social"><span>ğŸ˜Š</span><span data-i18n="booking.sociality_options.social">ÎšÎ¿Î¹Î½Ï‰Î½Î¹ÎºÏŒÏ‚</span></button>
              <button type="button" data-code="quiet"><span>ğŸ¤«</span><span data-i18n="booking.sociality_options.quiet">Î‰ÏƒÏ…Ï‡Î¿Ï‚</span></button>
            </div>
          </div>
        </div>
      </article>
    </section>

    <div class="cta-bar step2-cta">
      <button id="s2Back" class="btn-secondary" data-i18n="booking.return_button">Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î®</button>
      <button id="s2Next" class="btn-primary" data-i18n="booking.next">Î•Ï€ÏŒÎ¼ÎµÎ½Î¿</button>
    </div>
  </main>

  <!-- Overlays: About, AI Assistant, Profile -->
  <div id="aboutOverlay" class="overlay" role="dialog" aria-modal="true" hidden>
    <button class="close-overlay" onclick="closeOverlay('aboutOverlay')" data-i18n-aria="ui.close">Ã—</button>
    <div class="overlay-inner">
      <h2 data-i18n="about.title">Î£Ï‡ÎµÏ„Î¹ÎºÎ¬ Î¼Îµ ÎµÎ¼Î¬Ï‚</h2>
      <p data-i18n="about.text">Î¤Î¿ Greekaway Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ Î³Î¹Î± Î½Î± ÏƒÎ±Ï‚ Ï€ÏÎ¿ÏƒÏ†Î­ÏÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½ÎµÏ‚ ÎµÎºÎ´ÏÎ¿Î¼Î­Ï‚ ÏƒÏ„Î·Î½ Î•Î»Î»Î¬Î´Î± Î¼Îµ Î¬Î½ÎµÏƒÎ·, Ï„ÎµÏ‡Î½Î¿Î»Î¿Î³Î¯Î± ÎºÎ±Î¹ ÏƒÏ„Ï…Î».</p>
    </div>
  </div>

  <div id="aiOverlay" class="overlay" role="dialog" aria-modal="true" hidden>
    <button class="close-overlay" onclick="closeOverlay('aiOverlay')" data-i18n-aria="ui.close">Ã—</button>
    <div class="overlay-inner">
      <h2 data-i18n="nav.ai">Î’Î¿Î·Î¸ÏŒÏ‚ AI</h2>
      <p data-i18n="welcome.ask">Î¡Ï‰Ï„Î®ÏƒÏ„Îµ Î¼Î±Ï‚ ÏŒ,Ï„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î³Î¹Î± Ï„Î·Î½ ÎµÎºÎ´ÏÎ¿Î¼Î® ÏƒÎ±Ï‚!</p>
    </div>
  </div>

  <!-- Footer will be injected from /partials/footer-inner.html by /js/footer.js -->
  <footer></footer>
  <!-- Optional: overlays can be added later if needed -->
  <!-- Modals / Popups -->
  <div id="suitcasePopup" class="suitcase-popup" role="dialog" aria-modal="true" hidden>
    <div class="suitcase-dialog">
      <div class="suitcase-title" data-i18n="booking.suitcases">Î‘Ï€Î¿ÏƒÎºÎµÏ…Î­Ï‚</div>
      <div class="suitcase-options">
        <div class="suitcase-item" data-type="small">
          <div class="si-label" data-i18n="booking.suitcase_small">Small â€“ Hand luggage (55 cm â‰ˆ 10 kg)</div>
          <div class="si-ctrls">
            <button class="btn-round si-dec">âˆ’</button>
            <div class="count si-count">0</div>
            <button class="btn-round si-inc">+</button>
          </div>
        </div>
        <div class="suitcase-item" data-type="medium">
          <div class="si-label" data-i18n="booking.suitcase_medium">Medium â€“ 20 kg Suitcase (65 cm)</div>
          <div class="si-ctrls">
            <button class="btn-round si-dec">âˆ’</button>
            <div class="count si-count">0</div>
            <button class="btn-round si-inc">+</button>
          </div>
        </div>
        <div class="suitcase-item" data-type="large">
          <div class="si-label" data-i18n="booking.suitcase_large">Large â€“ 40 kg Suitcase (80 cm)</div>
          <div class="si-ctrls">
            <button class="btn-round si-dec">âˆ’</button>
            <div class="count si-count">0</div>
            <button class="btn-round si-inc">+</button>
          </div>
        </div>
      </div>
      <div class="suitcase-actions">
        <button type="button" class="btn" id="suitcaseConfirm" data-i18n="booking.confirm">Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·</button>
        <button type="button" class="btn btn-secondary" id="suitcaseCancel" data-i18n="ui.cancel">Î†ÎºÏ…ÏÎ¿</button>
      </div>
    </div>
  </div>

  <div id="pickupMapModal" class="map-modal" role="dialog" aria-modal="true" hidden>
    <div class="map-dialog">
      <div class="map-title" data-i18n="booking.pickup_map_preview">Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Ï‡Î¬ÏÏ„Î·</div>
      <div id="pickupMap" class="map-area"></div>
      <div class="map-actions">
        <button type="button" class="btn" id="mapConfirm" data-i18n="booking.confirm">Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·</button>
        <button type="button" class="btn btn-secondary" id="mapChange" data-i18n="booking.change">Î‘Î»Î»Î±Î³Î®</button>
      </div>
    </div>
  </div>

  <!-- Load i18n first so translations are ready before other logic; add cache-busting -->
  <script src="/js/i18n.js?v=20251022" defer></script>
  <script src="/js/overlay-manager.js?v=2" defer></script>
  <script src="/js/assistant.js?v=2" defer></script>
  <!-- Shared booking state utilities -->
  <script src="/js/booking-state.js" defer></script>
  <!-- Step 2 addons: suitcases popup, pickup autocomplete, special requests, validation -->
  <script src="/js/booking-addons.js?v=1" defer></script>
  <!-- Trip mode dynamic logic (van/private/bus) -->
  <script src="/js/step2-trip-mode.js" defer></script>
  <script>
    try { document.body.classList.add('has-rounded-footer'); } catch(_){ }
  </script>
  <script>
    // Optional: lightweight behaviour â€” Î Î¯ÏƒÏ‰ Î³Ï…ÏÎ¯Î¶ÎµÎ¹ ÏƒÏ„Î·Î½ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î· ÏƒÎµÎ»Î¯Î´Î±
    try { document.getElementById('s2Back').addEventListener('click', () => history.back()); } catch(_){ }
    // Populate header from sessionStorage (set in Step 1)
    (function hydrateStep2Header() {
      const headerEl = document.querySelector('.step2-header');
      const titleEl = document.getElementById('s2TripTitle');
      const dateEl = document.getElementById('s2TripDate');
      const priceEl = document.getElementById('s2PriceLine');
      const modeEl = document.getElementById('s2ModeLabel');
      const storedTitle = sessionStorage.getItem('gw_trip_title') || '';
      const tripId = sessionStorage.getItem('gw_trip_id') || '';
      const modeKey = normalizeModeKey(sessionStorage.getItem('gw_trip_mode') || '');
      const modeLabels = { bus: 'ÎŸÎ¼Î±Î´Î¹ÎºÏŒ Î»ÎµÏ‰Ï†Î¿ÏÎµÎ¯Î¿', van: 'Mini van', mercedes: 'Î™Î´Î¹Ï‰Ï„Î¹ÎºÎ® Î¼ÎµÏ„Î±Ï†Î¿ÏÎ¬' };
      const priceCtx = {
        trip: null,
        modeKey,
        locale: resolvePriceLocale(),
        latestAdults: 1
      };
      priceCtx.latestAdults = Math.max(1, getAdultsForPricing());
      const cachedTrip = (window.__loadedTrip && typeof window.__loadedTrip === 'object') ? window.__loadedTrip : null;
      if (cachedTrip && !priceCtx.trip) {
        priceCtx.trip = cachedTrip;
        if (!priceCtx.modeKey) priceCtx.modeKey = normalizeModeKey(cachedTrip.defaultMode || priceCtx.modeKey || '');
        try { updatePriceLine(priceCtx.latestAdults); } catch(_){}
      }
      let tripDate = sessionStorage.getItem('gw_trip_date') || '';
      try {
        const urlDate = (new URLSearchParams(window.location.search)).get('date');
        if (!tripDate && urlDate) {
          sessionStorage.setItem('gw_trip_date', urlDate);
          tripDate = urlDate;
        }
      } catch (_) {}
      if (storedTitle && titleEl) titleEl.textContent = storedTitle;
      if (dateEl) dateEl.textContent = tripDate || 'â€”';
      if (modeEl) {
        const friendly = modeLabels[modeKey] || (modeKey ? modeKey.toUpperCase() : '');
        if (friendly) {
          modeEl.textContent = friendly;
          modeEl.hidden = false;
        } else {
          modeEl.hidden = true;
        }
      }
      if (priceEl) priceEl.textContent = priceEl.textContent && priceEl.textContent.trim() !== '' ? priceEl.textContent : 'â€”';
      if (!storedTitle && !tripId && headerEl) {
        headerEl.style.display = 'none';
        return;
      }
      if (!tripId) return;

      (async function loadTripForHeader() {
        try {
          const lang = (localStorage.getItem('gw_lang') || 'el');
          const trip = await fetchTripPayload(tripId);
          if (!trip) return;
          try { window.__loadedTrip = trip; } catch (_) {}
          const title = getLocalized(trip.title, lang) || storedTitle;
          priceCtx.trip = trip;
          priceCtx.modeKey = modeKey || priceCtx.modeKey;
          try { window.__step2PriceCtx = priceCtx; } catch(_){}
          const modeBlock = pickModeBlock(trip, priceCtx.modeKey);
          if (title && titleEl) titleEl.textContent = title;
          updatePriceLine(priceCtx.latestAdults);
        } catch (err) {
          console.error('[step2] header hydrate failed', err);
        }
      })();

      async function fetchTripPayload(id) {
        if (!id) return null;
        let dv = '';
        try {
          const rv = await fetch('/version.json', { cache: 'no-cache' });
          if (rv.ok) {
            const meta = await rv.json();
            if (meta && meta.dataVersion) dv = '?v=' + encodeURIComponent(String(meta.dataVersion));
          }
        } catch (_) {}

        const staticUrl = `/data/trips/${encodeURIComponent(id)}.json${dv}`;
        const staticTrip = await tryFetchJSON(staticUrl, { cache: 'no-cache' });
        if (staticTrip) return staticTrip;

        const apiUrl = `/api/trips/${encodeURIComponent(id)}`;
        const apiTrip = await tryFetchJSON(apiUrl, { cache: 'no-store' }, true);
        if (apiTrip && apiTrip.trip) return apiTrip.trip;
        return apiTrip;
      }

      async function tryFetchJSON(url, options, treat404AsNull) {
        try {
          const res = await fetch(url, options || {});
          if (!res.ok) {
            if (treat404AsNull && res.status === 404) return null;
            return null;
          }
          return res.json();
        } catch (_) {
          return null;
        }
      }

      function getLocalized(field, lang) {
        if (!field) return '';
        if (typeof field === 'string') return field;
        if (typeof field === 'object') return field[lang] || field.el || Object.values(field)[0] || '';
        return '';
      }

      function pickModeBlock(trip, key) {
        if (!trip || !trip.modes) return null;
        const normalized = normalizeModeKey(key);
        if (normalized && trip.modes[normalized]) return trip.modes[normalized];
        if (trip.defaultMode && trip.modes[trip.defaultMode]) return trip.modes[trip.defaultMode];
        const activeKey = Object.keys(trip.modes).find((mode) => trip.modes[mode] && trip.modes[mode].active);
        if (activeKey) return trip.modes[activeKey];
        const firstKey = Object.keys(trip.modes)[0];
        return firstKey ? trip.modes[firstKey] : null;
      }

      function formatPriceLine(trip, modeBlock, adultsOverride) {
        if (!trip || !modeBlock) return '';
        const currency = (trip.currency || 'EUR').toUpperCase();
        const adultsCount = Math.max(1, adultsOverride || getAdultsForPricing());
        const amount = computePriceAmount(modeBlock, adultsCount);
        if (!amount) return '';
        return formatCurrency(amount, currency, priceCtx.locale);
      }

      function computePriceAmount(modeBlock, adultsCount) {
        if (!modeBlock) return 0;
        const charge = String(modeBlock.charge_type || '').toLowerCase();
        const pricePerPerson = Number(modeBlock.price_per_person) || 0;
        const priceTotal = Number(modeBlock.price_total) || 0;
        if (pricePerPerson > 0) {
          return pricePerPerson * Math.max(1, adultsCount || 1);
        }
        if (priceTotal > 0) return priceTotal;
        if (charge === 'per_vehicle' && priceTotal > 0) return priceTotal;
        return 0;
      }

      function formatCurrency(amount, currency, locale) {
        if (!(amount > 0)) return '';
        try {
          return new Intl.NumberFormat(locale || 'el-GR', {
            style: 'currency',
            currency: currency || 'EUR'
          }).format(amount);
        } catch (_) {
          return `${amount.toFixed(2)} ${currency || 'EUR'}`;
        }
      }

      function getAdultsForPricing() {
        const el = document.getElementById('adultsCount');
        if (el) {
          const val = parseInt((el.textContent || '').trim(), 10);
          if (Number.isFinite(val) && val > 0) return val;
        }
        try {
          const fromSession = parseInt(sessionStorage.getItem('gw_adults') || '0', 10);
          if (Number.isFinite(fromSession) && fromSession > 0) return fromSession;
        } catch (_) {}
        return 1;
      }

      function normalizeModeKey(mode) {
        const normalized = String(mode || '').toLowerCase().trim();
        if (!normalized) return '';
        if (normalized === 'mercedes/private' || normalized === 'private' || normalized === 'vip') return 'mercedes';
        if (normalized === 'multi' || normalized === 'shared') return 'van';
        if (normalized === 'minivan') return 'van';
        return normalized;
      }

      function resolvePriceLocale() {
        try {
          const lang = (localStorage.getItem('gw_lang') || 'el').toLowerCase();
          if (lang === 'en') return 'en-US';
          if (lang === 'fr') return 'fr-FR';
          if (lang === 'it') return 'it-IT';
          if (lang === 'es') return 'es-ES';
          if (lang === 'de') return 'de-DE';
          return 'el-GR';
        } catch (_) {
          return 'el-GR';
        }
      }

      function updatePriceLine(adultsOverride) {
        priceCtx.latestAdults = Math.max(1, adultsOverride || getAdultsForPricing());
        if (!priceCtx.trip || !priceEl) {
          if (priceEl) priceEl.textContent = 'â€”';
          return;
        }
        const modeBlock = pickModeBlock(priceCtx.trip, priceCtx.modeKey);
        const amountValue = computePriceAmount(modeBlock, priceCtx.latestAdults);
        const priceText = formatPriceLine(priceCtx.trip, modeBlock, priceCtx.latestAdults);
        priceEl.textContent = priceText || 'â€”';
        try {
          if (amountValue > 0) {
            sessionStorage.setItem('gw_amount_cents', String(Math.round(amountValue * 100)));
            sessionStorage.setItem('gw_amount_currency', (priceCtx.trip.currency || 'EUR').toUpperCase());
          } else {
            sessionStorage.removeItem('gw_amount_cents');
            sessionStorage.removeItem('gw_amount_currency');
          }
        } catch(_){ }
      }

      try {
        window.updateStep2Price = (adultsOverride) => updatePriceLine(adultsOverride);
        window.__step2PriceCtx = priceCtx;
      } catch (_) {}
    })();

    // Force-apply translations to all nodes inside Step 2 area
    function applyTranslationsToStep2() {
      try {
        if (!window.t) return;
        // narrow scope to the step2 container to avoid global reflow
        const root = document.body;
        const selAll = root.querySelectorAll('[data-i18n], [data-i18n-placeholder], [data-i18n-title], [data-i18n-aria], [data-i18n-value]');
        selAll.forEach(el => {
          try {
            if (el.hasAttribute('data-i18n')) {
              const key = el.getAttribute('data-i18n');
              const val = window.t(key);
              if (val && val !== key) el.textContent = val;
            }
            if (el.hasAttribute('data-i18n-placeholder')) {
              const key = el.getAttribute('data-i18n-placeholder');
              const val = window.t(key);
              if (val && val !== key) el.setAttribute('placeholder', val);
            }
            if (el.hasAttribute('data-i18n-title')) {
              const key = el.getAttribute('data-i18n-title');
              const val = window.t(key);
              if (val && val !== key) el.setAttribute('title', val);
            }
            if (el.hasAttribute('data-i18n-aria')) {
              const key = el.getAttribute('data-i18n-aria');
              const val = window.t(key);
              if (val && val !== key) el.setAttribute('aria-label', val);
            }
            if (el.hasAttribute('data-i18n-value')) {
              const key = el.getAttribute('data-i18n-value');
              const val = window.t(key);
              if (val && val !== key) el.value = val;
            }
          } catch(_){}
        });
      } catch(_){}
    }

    // Passenger counters with seat-limit enforcement
    (function(){
        function tSafe(key, fallback){
          try { const v = (window.t && window.t(key)) || ''; return (v && v !== key) ? v : fallback; } catch(_){ return fallback; }
        }
      const adultsCount = document.getElementById('adultsCount');
      const childrenCount = document.getElementById('childrenCount');
      const childrenAgesEl = document.getElementById('childrenAges');
      const agePicker = document.getElementById('agePicker');
      const seatLimitNotice = document.getElementById('seatLimitNotice');
      const seatLimitMessageEl = document.getElementById('seatLimitMessage');
      const seatLimitErrorEl = document.getElementById('seatLimitError');
      const headErrorEl = document.getElementById('s2HeadError');
      const nextBtn = document.getElementById('s2Next');
      const ages = [];
      const MAX_TOTAL_PASSENGERS = 50;
      const urlParams = (()=>{ try { return new URLSearchParams(window.location.search); } catch(_){ return new URLSearchParams(''); } })();
      const seatLimitState = { limit: null };
      const getN = (el) => parseInt((el && el.textContent) || '0', 10) || 0;
      const setN = (el, n) => { if (el) el.textContent = String(n); };

      function parseSeatLimit(value){
        if (value == null || value === '') return null;
        const num = Number(value);
        if (!Number.isFinite(num)) return null;
        return Math.max(0, Math.floor(num));
      }
      function getSeatLimit(){ return seatLimitState.limit; }
      function persistSeatLimit(val){
        try {
          if (val == null) { sessionStorage.removeItem('gw_seats_available'); return; }
          sessionStorage.setItem('gw_seats_available', String(val));
        } catch(_){ }
      }
      function restoreNextButton(){
        if (nextBtn && nextBtn.dataset.userDisabled === 'seat-limit') {
          nextBtn.disabled = false;
          delete nextBtn.dataset.userDisabled;
        }
      }
      function showHeadNoSeats(){
        if (!headErrorEl) return;
        headErrorEl.dataset.seatLimit = '1';
        headErrorEl.textContent = 'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼ÎµÏ‚ Î¸Î­ÏƒÎµÎ¹Ï‚ Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±.';
        headErrorEl.removeAttribute('hidden');
      }
      function clearHeadSeatError(){
        if (headErrorEl && headErrorEl.dataset.seatLimit === '1') {
          headErrorEl.setAttribute('hidden','');
          delete headErrorEl.dataset.seatLimit;
        }
      }
      function updateSeatLimitNotice(){
        const limit = getSeatLimit();
        if (!seatLimitNotice) return;
        if (limit == null) {
          seatLimitNotice.setAttribute('hidden','');
          clearHeadSeatError();
          restoreNextButton();
          return;
        }
        seatLimitNotice.removeAttribute('hidden');
        if (seatLimitMessageEl) {
          seatLimitMessageEl.textContent = limit > 0
            ? `Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼ÎµÏ‚ Î¸Î­ÏƒÎµÎ¹Ï‚: ${limit}`
            : 'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼ÎµÏ‚ Î¸Î­ÏƒÎµÎ¹Ï‚ Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±.';
        }
        if (limit <= 0) {
          showHeadNoSeats();
          if (nextBtn) {
            nextBtn.disabled = true;
            nextBtn.dataset.userDisabled = 'seat-limit';
          }
        } else {
          restoreNextButton();
          clearHeadSeatError();
        }
      }
      function setSeatLimit(value, opts = {}){
        const normalized = value == null ? null : parseSeatLimit(value);
        seatLimitState.limit = normalized;
        if (!opts.skipPersist) persistSeatLimit(normalized);
        updateSeatLimitNotice();
        if (!opts.skipClamp) clampPassengersToLimit(false);
      }
      function readSeatLimitFromSources(){
        let picked = null;
        try {
          picked = parseSeatLimit(urlParams.get('seatsAvailable'));
        } catch(_){ picked = null; }
        if (picked == null) {
          try { picked = parseSeatLimit(sessionStorage.getItem('gw_seats_available')); } catch(_){ picked = null; }
        }
        setSeatLimit(picked, { skipClamp: true });
      }
      function showSeatLimitError(limitOverride){
        const limit = (limitOverride != null ? limitOverride : getSeatLimit());
        if (!seatLimitErrorEl || limit == null) return;
        seatLimitErrorEl.textContent = `ÎŸ Î¼Î­Î³Î¹ÏƒÏ„Î¿Ï‚ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎµÏ€Î¹Î²Î±Ï„ÏÎ½ Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± ÎµÎ¯Î½Î±Î¹ ${limit}.`;
        seatLimitErrorEl.removeAttribute('hidden');
      }
      function clearSeatLimitError(){
        seatLimitErrorEl?.setAttribute('hidden','');
      }
      function persistAdults(n){
        try { sessionStorage.setItem('gw_adults', String(n)); } catch(_){ }
      }
      function totalPassengers(adultsOverride, childrenOverride){
        const adultsVal = Number.isFinite(adultsOverride) ? adultsOverride : getN(adultsCount);
        const childVal = Number.isFinite(childrenOverride) ? childrenOverride : ages.length;
        return Math.max(0, adultsVal) + Math.max(0, childVal);
      }
      function remainingSeats(){
        const limit = getSeatLimit();
        if (limit == null) return Infinity;
        return limit - totalPassengers();
      }
      function clampAdultsValue(value){
        const limit = getSeatLimit();
        const hardMax = limit == null ? MAX_TOTAL_PASSENGERS : Math.min(MAX_TOTAL_PASSENGERS, limit);
        return Math.max(1, Math.min(value, hardMax));
      }
      function wouldExceedLimit(nextAdults, nextChildren){
        const limit = getSeatLimit();
        if (limit == null) return false;
        return (nextAdults + nextChildren) > limit;
      }
      function clampPassengersToLimit(showMessage){
        let changed = false;
        const limit = getSeatLimit();
        const hardMax = limit == null ? MAX_TOTAL_PASSENGERS : Math.min(MAX_TOTAL_PASSENGERS, limit);
        let adultsVal = clampAdultsValue(getN(adultsCount));
        if (adultsVal !== getN(adultsCount)) {
          setN(adultsCount, adultsVal);
          changed = true;
        }
        let allowedChildren = Math.max(0, hardMax - adultsVal);
        if (ages.length > allowedChildren) {
          ages.splice(allowedChildren);
          setN(childrenCount, ages.length);
          changed = true;
        }
        if (limit === 0) {
          if (showMessage) showSeatLimitError(0);
          return true;
        }
        if (changed) {
          renderAges();
          persistAdults(adultsVal);
          try { window.updateStep2Price && window.updateStep2Price(adultsVal); } catch(_){ }
          if (showMessage && limit != null) showSeatLimitError(limit);
        }
        return changed;
      }
      function deriveSeatLimitFromPayload(payload){
        if (!payload) return null;
        if (payload.available != null) {
          const parsed = parseSeatLimit(payload.available);
          if (parsed != null) return parsed;
        }
        if (payload.remaining_fleet != null) {
          const parsedFleet = parseSeatLimit(payload.remaining_fleet);
          if (parsedFleet != null) return parsedFleet;
        }
        return null;
      }
      function getBookingMeta(){
        return {
          tripId: (sessionStorage.getItem('gw_trip_id') || urlParams.get('trip') || '').trim(),
          date: (sessionStorage.getItem('gw_trip_date') || urlParams.get('date') || '').trim(),
          mode: (sessionStorage.getItem('gw_trip_mode') || urlParams.get('mode') || '').trim()
        };
      }
      async function refreshSeatLimitFromApi(options = {}){
        const meta = getBookingMeta();
        if (!meta.tripId || !meta.date || !meta.mode) return null;
        try {
          const url = `/api/availability?trip_id=${encodeURIComponent(meta.tripId)}&mode=${encodeURIComponent(meta.mode)}&date=${encodeURIComponent(meta.date)}`;
          const res = await fetch(url, { cache: 'no-store' });
          if (!res.ok) return null;
          const data = await res.json();
          const apiLimit = deriveSeatLimitFromPayload(data);
          if (apiLimit == null) return null;
          setSeatLimit(apiLimit, { skipClamp: true });
          const changed = clampPassengersToLimit(options.forceMessage === true);
          if (options.forceMessage && (changed || totalPassengers() > apiLimit)) {
            showSeatLimitError(apiLimit);
          }
          return apiLimit;
        } catch(_){ return null; }
      }
      async function ensureSeatAvailabilityBeforeNext(){
        await refreshSeatLimitFromApi({ forceMessage: true });
        const limit = getSeatLimit();
        if (limit == null) return true;
        if (limit <= 0) {
          showSeatLimitError(limit);
          return false;
        }
        if (totalPassengers() > limit) {
          clampPassengersToLimit(true);
          showSeatLimitError(limit);
          return false;
        }
        return true;
      }
      const renderAges = () => {
        if (!childrenAgesEl) return;
        if (ages.length === 0) {
          const hint = (window.t ? window.t('booking.pick_ages') : 'Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î·Î»Î¹ÎºÎ¯ÎµÏ‚');
          childrenAgesEl.innerHTML = '<span class="hint" data-i18n="booking.pick_ages"></span>';
          const span = childrenAgesEl.querySelector('.hint');
          if (span) span.textContent = hint;
          try { sessionStorage.setItem('gw_children_ages', JSON.stringify([])); } catch(_){ }
        } else {
          childrenAgesEl.textContent = ages.join(', ');
          try { sessionStorage.setItem('gw_children_ages', JSON.stringify(ages)); } catch(_){ }
        }
      };
      const openPicker = () => {
        if (!agePicker) return;
        if (remainingSeats() <= 0) {
          showSeatLimitError();
          return;
        }
        if (ages.length >= MAX_TOTAL_PASSENGERS) return;
        if (agePicker.childElementCount === 0) {
          for (let i = 1; i <= 17; i++) {
            const b = document.createElement('button');
            b.type = 'button';
            b.textContent = String(i);
            b.addEventListener('click', ()=>{
              const currentAdults = getN(adultsCount);
              if (wouldExceedLimit(currentAdults, ages.length + 1)) {
                showSeatLimitError();
                closePicker();
                return;
              }
              ages.push(i);
              setN(childrenCount, ages.length);
              renderAges();
              clearSeatLimitError();
              closePicker();
            });
            agePicker.appendChild(b);
          }
        }
        agePicker.hidden = false;
        const row = agePicker.closest('.s2-row');
        if (row) {
          const rect = row.getBoundingClientRect();
          const spaceBelow = window.innerHeight - rect.bottom;
          agePicker.classList.toggle('dropup', spaceBelow < 260);
        }
        setTimeout(()=>{
          const onDoc = (ev) => {
            if (!agePicker.contains(ev.target)) { closePicker(); document.removeEventListener('click', onDoc); }
          };
          document.addEventListener('click', onDoc);
        }, 0);
      };
      const closePicker = () => { if (agePicker) agePicker.hidden = true; };

      document.getElementById('adultsDec')?.addEventListener('click', ()=>{
        const current = getN(adultsCount);
        if (current <= 1) return;
        const next = Math.max(1, current - 1);
        setN(adultsCount, next);
        persistAdults(next);
        clearSeatLimitError();
        try { window.updateStep2Price && window.updateStep2Price(next); } catch(_){ }
      });
      document.getElementById('adultsInc')?.addEventListener('click', ()=>{
        const proposed = getN(adultsCount) + 1;
        if (wouldExceedLimit(proposed, ages.length)) {
          showSeatLimitError();
          return;
        }
        const next = clampAdultsValue(proposed);
        setN(adultsCount, next);
        persistAdults(next);
        clearSeatLimitError();
        try { window.updateStep2Price && window.updateStep2Price(next); } catch(_){ }
      });
      document.getElementById('childrenDec')?.addEventListener('click', ()=>{
        if (!ages.length) return;
        ages.pop();
        setN(childrenCount, ages.length);
        renderAges();
        clearSeatLimitError();
      });
      document.getElementById('childrenInc')?.addEventListener('click', (e)=>{
        e.stopPropagation();
        if (remainingSeats() <= 0) {
          showSeatLimitError();
          return;
        }
        openPicker();
      });

      readSeatLimitFromSources();
      clampPassengersToLimit(false);
      updateSeatLimitNotice();
      refreshSeatLimitFromApi();
      renderAges();
      (function syncAdults(){
        const current = Math.max(1, getN(adultsCount) || 1);
        persistAdults(current);
        try { window.updateStep2Price && window.updateStep2Price(current); } catch(_){ }
      })();

      // expose validator for Next button handler
      window.__ensureSeatAvailabilityBeforeNext = ensureSeatAvailabilityBeforeNext;

      // Suitcases field: handled in booking-addons.js

      // Age group selector
      const ageBtn = document.getElementById('ageSelectBtn');
      const ageMenu = document.getElementById('ageMenu');
      const setAgeGroup = (code, label) => {
        const lblEl = ageBtn?.querySelector('.label');
        lblEl?.replaceChildren(document.createTextNode(label));
        // Prevent i18n auto-apply from reverting to "Choose"
        lblEl?.removeAttribute('data-i18n');
        try { sessionStorage.setItem('gw_age_group', code); } catch(_){ }
      };
  const ageMap = { '20-30':'20â€“30', '30-40':'30â€“40', '40-55':'40â€“55', '55+':'55+' };
      const defaultAge = (()=>{ try { return sessionStorage.getItem('gw_age_group') || ''; } catch(_){ return ''; } })();
      if (defaultAge && ageMap[defaultAge]) setAgeGroup(defaultAge, ageMap[defaultAge]);
  ageBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); if (ageMenu) { ageMenu.hidden = !ageMenu.hidden; if (!ageMenu.hidden) { const row = ageMenu.closest('.s2-row'); if (row) { const rect = row.getBoundingClientRect(); const spaceBelow = window.innerHeight - rect.bottom; ageMenu.classList.toggle('dropup', spaceBelow < 220); } } try { applyTranslationsToStep2(); } catch(_){} } });
      ageMenu?.querySelectorAll('button')?.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const code = btn.getAttribute('data-code') || '';
          const label = ageMap[code] || 'Î•Ï€Î¹Î»Î­Î¾Ï„Îµ';
          setAgeGroup(code, label);
          if (ageMenu) ageMenu.hidden = true;
          // Clear inline error and red border if any
          try {
            document.getElementById('ageGroupTitle')?.classList.remove('required');
            document.getElementById('ageGroupError')?.setAttribute('hidden','');
            document.getElementById('ageSelectBtn')?.classList.remove('error');
          } catch(_){ }
          // Notify shared logic to update Next button visual state
          try { document.dispatchEvent(new CustomEvent('gw:step2:fieldsChanged')); } catch(_){ }
        });
      });
      document.addEventListener('click', (e)=>{
        if (ageMenu && !ageMenu.hidden && !ageMenu.contains(e.target) && e.target !== ageBtn) ageMenu.hidden = true;
      });

      // Traveler type selector
      const travTypeBtn = document.getElementById('travTypeSelectBtn');
      const travTypeMenu = document.getElementById('travTypeMenu');
      const travTypeFallback = {
        explore: 'Î•Î¾ÎµÏÎµÏ…Î½Î·Ï„Î­Ï‚ â€“ Î´ÏÎ±ÏƒÏ„Î®ÏÎ¹Î¿Î¹',
        relax: 'Î§Î±Î»Î±ÏÎ¿Î¯ Ï„Î±Î¾Î¹Î´Î¹ÏÏ„ÎµÏ‚',
        family: 'ÎŸÎ¹ÎºÎ¿Î³ÎµÎ½ÎµÎ¹Î±ÎºÏŒ ÏÏ†Î¿Ï‚',
        solo: 'ÎœÎ¿Î½Î±Ï‡Î¹ÎºÎ¿Î¯ Ï„Î±Î¾Î¹Î´Î¹ÏÏ„ÎµÏ‚'
      };
      const setTravType = (code) => {
        const label = (code ? (window.t ? window.t('booking.traveler_type_options.' + code) : (travTypeFallback[code] || 'Î•Ï€Î¹Î»Î­Î¾Ï„Îµ')) : 'Î•Ï€Î¹Î»Î­Î¾Ï„Îµ');
        const lblEl = travTypeBtn?.querySelector('.label');
        lblEl?.replaceChildren(document.createTextNode(label));
        lblEl?.removeAttribute('data-i18n');
        try { sessionStorage.setItem('gw_traveler_type', code); } catch(_){ }
      };
      const defaultTravType = (()=>{ try { return sessionStorage.getItem('gw_traveler_type') || ''; } catch(_){ return ''; } })();
      if (defaultTravType) setTravType(defaultTravType);
  travTypeBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); if (travTypeMenu) { travTypeMenu.hidden = !travTypeMenu.hidden; if (!travTypeMenu.hidden) { const row = travTypeMenu.closest('.s2-row'); if (row) { const rect = row.getBoundingClientRect(); const spaceBelow = window.innerHeight - rect.bottom; travTypeMenu.classList.toggle('dropup', spaceBelow < 220); } } try { applyTranslationsToStep2(); } catch(_){} } });
      travTypeMenu?.querySelectorAll('button')?.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const code = btn.getAttribute('data-code') || '';
          setTravType(code);
          if (travTypeMenu) travTypeMenu.hidden = true;
          // Clear inline error and red border if any
          try {
            document.getElementById('travTypeTitle')?.classList.remove('required');
            document.getElementById('travTypeError')?.setAttribute('hidden','');
            document.getElementById('travTypeSelectBtn')?.classList.remove('error');
          } catch(_){ }
          // Notify shared logic to update Next button visual state
          try { document.dispatchEvent(new CustomEvent('gw:step2:fieldsChanged')); } catch(_){ }
        });
      });
      document.addEventListener('click', (e)=>{
        if (travTypeMenu && !travTypeMenu.hidden && !travTypeMenu.contains(e.target) && e.target !== travTypeBtn) travTypeMenu.hidden = true;
      });

      // Interests selector
      const interestBtn = document.getElementById('interestSelectBtn');
      const interestMenu = document.getElementById('interestMenu');
      const interestFallback = {
        nature: 'Î¦ÏÏƒÎ·',
        culture: 'Î Î¿Î»Î¹Ï„Î¹ÏƒÎ¼ÏŒÏ‚',
        mountain: 'Î’Î¿Ï…Î½ÏŒ',
        sea: 'Î˜Î¬Î»Î±ÏƒÏƒÎ±',
        gastronomy: 'Î“Î±ÏƒÏ„ÏÎ¿Î½Î¿Î¼Î¯Î±'
      };
      const setInterest = (code) => {
        const label = (code ? (window.t ? window.t('booking.interests_options.' + code) : (interestFallback[code] || 'Î•Ï€Î¹Î»Î­Î¾Ï„Îµ')) : 'Î•Ï€Î¹Î»Î­Î¾Ï„Îµ');
        const lblEl = interestBtn?.querySelector('.label');
        lblEl?.replaceChildren(document.createTextNode(label));
        lblEl?.removeAttribute('data-i18n');
        try { sessionStorage.setItem('gw_interest', code); } catch(_){ }
      };
      const defaultInterest = (()=>{ try { return sessionStorage.getItem('gw_interest') || ''; } catch(_){ return ''; } })();
      if (defaultInterest) setInterest(defaultInterest);
  interestBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); if (interestMenu) { interestMenu.hidden = !interestMenu.hidden; if (!interestMenu.hidden) { const row = interestMenu.closest('.s2-row'); if (row) { const rect = row.getBoundingClientRect(); const spaceBelow = window.innerHeight - rect.bottom; interestMenu.classList.toggle('dropup', spaceBelow < 220); } } try { applyTranslationsToStep2(); } catch(_){} } });
      interestMenu?.querySelectorAll('button')?.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const code = btn.getAttribute('data-code') || '';
          setInterest(code);
          if (interestMenu) interestMenu.hidden = true;
          try { document.dispatchEvent(new CustomEvent('gw:step2:fieldsChanged')); } catch(_){ }
        });
      });
      document.addEventListener('click', (e)=>{
        if (interestMenu && !interestMenu.hidden && !interestMenu.contains(e.target) && e.target !== interestBtn) interestMenu.hidden = true;
      });

      // Sociality selector
      const socialBtn = document.getElementById('socialSelectBtn');
      const socialMenu = document.getElementById('socialMenu');
      const socialFallback = { social: 'ÎšÎ¿Î¹Î½Ï‰Î½Î¹ÎºÏŒÏ‚', quiet: 'Î‰ÏƒÏ…Ï‡Î¿Ï‚' };
      const setSocial = (code) => {
        const label = (code ? (window.t ? window.t('booking.sociality_options.' + code) : (socialFallback[code] || 'Î•Ï€Î¹Î»Î­Î¾Ï„Îµ')) : 'Î•Ï€Î¹Î»Î­Î¾Ï„Îµ');
        const lblEl = socialBtn?.querySelector('.label');
        lblEl?.replaceChildren(document.createTextNode(label));
        lblEl?.removeAttribute('data-i18n');
        try { sessionStorage.setItem('gw_sociality', code); } catch(_){ }
      };
      const defaultSocial = (()=>{ try { return sessionStorage.getItem('gw_sociality') || ''; } catch(_){ return ''; } })();
      if (defaultSocial) setSocial(defaultSocial);
  socialBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); if (socialMenu) { socialMenu.hidden = !socialMenu.hidden; if (!socialMenu.hidden) { const row = socialMenu.closest('.s2-row'); if (row) { const rect = row.getBoundingClientRect(); const spaceBelow = window.innerHeight - rect.bottom; socialMenu.classList.toggle('dropup', spaceBelow < 220); } } try { applyTranslationsToStep2(); } catch(_){} } });
      socialMenu?.querySelectorAll('button')?.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const code = btn.getAttribute('data-code') || '';
          setSocial(code);
          if (socialMenu) socialMenu.hidden = true;
          try { document.dispatchEvent(new CustomEvent('gw:step2:fieldsChanged')); } catch(_){ }
        });
      });
      document.addEventListener('click', (e)=>{
        if (socialMenu && !socialMenu.hidden && !socialMenu.contains(e.target) && e.target !== socialBtn) socialMenu.hidden = true;
      });

      // Persist all values as a single bookingState and go to Step 3
      document.getElementById('s2Next')?.addEventListener('click', async (ev)=>{
        try { ev.preventDefault(); } catch(_){ }
        if (window.__ensureSeatAvailabilityBeforeNext) {
          try {
            const ok = await window.__ensureSeatAvailabilityBeforeNext();
            if (!ok) return;
          } catch(_){ }
        }
        try {
          // sync counters to session for compatibility with existing UI helpers
          sessionStorage.setItem('gw_adults', String(getN(adultsCount)));
          sessionStorage.setItem('gw_children_ages', JSON.stringify(ages));
          sessionStorage.setItem('gw_dropoff_same', 'true');
        } catch(_){ }
        try {
          if (window.GWBookingState && window.GWBookingState.buildFromStep2) {
            const st = await window.GWBookingState.buildFromStep2();
            try { console.log('[step2] bookingState saved', st); } catch(_){ }
          }
        } catch(_){ }
        const canonicalPath = '/booking/step3';
        const legacyPath = '/step3.html';
        try {
          const origin = (window.location && window.location.origin) || (window.location.protocol + '//' + window.location.host) || '';
          const buildUrl = (path) => origin ? (new URL(path, origin).href) : path;
          const targetUrl = buildUrl(canonicalPath);
          const fallbackUrl = buildUrl(legacyPath);
          try { window.location.assign(targetUrl); }
          catch(_e1){
            try { window.location.href = targetUrl; }
            catch(_e2){ setTimeout(()=>{ window.location.href = fallbackUrl; }, 0); }
          }
        } catch(_){ window.location.href = legacyPath; }
      });
      // Re-apply selected labels when language changes
      try {
      window.addEventListener('i18n:changed', () => {
          // Preferred language is now auto-assigned from current locale (no dropdown)

          try {
            const curTrav = sessionStorage.getItem('gw_traveler_type') || '';
            if (curTrav) setTravType(curTrav);
          } catch(_){ }
          try {
            const curInterest = sessionStorage.getItem('gw_interest') || '';
            if (curInterest) setInterest(curInterest);
          } catch(_){ }
          try {
            const curSocial = sessionStorage.getItem('gw_sociality') || '';
            if (curSocial) setSocial(curSocial);
          } catch(_){ }
          try {
            const curAge = sessionStorage.getItem('gw_age_group') || '';
            if (curAge) setAgeGroup(curAge, (ageMap[curAge] || ''));
          } catch(_){ }
          // Ages hint may need re-translation
          try { renderAges(); } catch(_){ }

          const modeLabels = { bus: 'ÎŸÎ¼Î±Î´Î¹ÎºÏŒ Î»ÎµÏ‰Ï†Î¿ÏÎµÎ¯Î¿', van: 'Mini van', mercedes: 'Î™Î´Î¹Ï‰Ï„Î¹ÎºÎ® Î¼ÎµÏ„Î±Ï†Î¿ÏÎ¬' };
          const normalizeMode = (mode) => {
            const normalized = String(mode || '').toLowerCase().trim();
            if (!normalized) return '';
            if (normalized === 'mercedes/private' || normalized === 'private' || normalized === 'vip') return 'mercedes';
            if (normalized === 'multi' || normalized === 'shared') return 'van';
            if (normalized === 'minivan') return 'van';
            return normalized;
          };
          const localize = (field, lang) => {
            if (!field) return '';
            if (typeof field === 'string') return field;
            if (typeof field === 'object') return field[lang] || field.el || Object.values(field)[0] || '';
            return '';
          };

          // Re-render trip title/description if we have cached trip JSON
          try {
            const t = window.__loadedTrip || null;
            if (t) {
              const lang = ((window.currentI18n && window.currentI18n.lang) || localStorage.getItem('gw_lang') || 'el');
              const storedMode = normalizeMode(sessionStorage.getItem('gw_trip_mode') || '');
              const title = localize(t.title, lang);
              const titleEl = document.getElementById('s2TripTitle');
              const priceEl = document.getElementById('s2PriceLine');
              const modeEl = document.getElementById('s2ModeLabel');
              if (titleEl && title) titleEl.textContent = title;
              try {
                const localeKey = String(lang || 'el').toLowerCase();
                const localeMap = { en: 'en-US', fr: 'fr-FR', it: 'it-IT', es: 'es-ES', de: 'de-DE' };
                if (window.__step2PriceCtx) {
                  window.__step2PriceCtx.locale = localeMap[localeKey] || 'el-GR';
                }
              } catch(_){}
              if (typeof window.updateStep2Price === 'function') {
                try {
                  window.__step2PriceCtx = window.__step2PriceCtx || {};
                  window.__step2PriceCtx.trip = t;
                  window.__step2PriceCtx.modeKey = storedMode || window.__step2PriceCtx.modeKey;
                } catch(_){ }
                window.updateStep2Price();
              } else if (priceEl) {
                priceEl.textContent = 'â€”';
              }
              if (modeEl) {
                const friendly = modeLabels[storedMode] || (storedMode ? storedMode.toUpperCase() : '');
                modeEl.hidden = !friendly;
                if (friendly) modeEl.textContent = friendly;
              }
            }
          } catch(_){ }
        });
      } catch(_){ }
      // Ensure translations are applied to step2 DOM nodes when i18n loads/changes
      try { window.addEventListener('i18n:changed', () => { try { applyTranslationsToStep2(); } catch(_){} }); } catch(_){ }
      // Also run once after DOM ready to catch initial language
      try { document.addEventListener('DOMContentLoaded', () => { try { applyTranslationsToStep2(); } catch(_){} }); } catch(_){ }
    })();
    // Ensure translations apply after DOM is fully ready (covers any early t() fallback rendering)
    document.addEventListener('DOMContentLoaded', function(){
      try { if (window.currentI18n && window.setLanguage) window.setLanguage(window.currentI18n.lang); } catch(_){ }
      try { setTimeout(() => { if (window.currentI18n && window.setLanguage) window.setLanguage(window.currentI18n.lang); }, 60); } catch(_){ }
    });
  </script>
  <script src="/pwa-install.js" defer></script>
  <!-- Inject shared footer (Option A unification) -->
  <script src="/js/footer.js" defer></script>
  <script src="/js/main.js"></script>
</body>
</html>
