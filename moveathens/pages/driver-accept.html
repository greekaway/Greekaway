<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>MoveAthens â€” Î‘Ï€Î¿Î´Î¿Ï‡Î® Î”Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚</title>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f0f4f8;color:#1a1a2e;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;transition:background .3s,color .3s}
    .card{background:#fff;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,.1);max-width:440px;width:100%;padding:28px 24px;text-align:center;transition:background .3s,box-shadow .3s}
    .logo{font-size:24px;font-weight:700;color:#001f3f;margin-bottom:20px}
    .logo span{color:#0d6efd}
    .trip-info{text-align:left;background:#f8f9fb;border-radius:12px;padding:16px;margin:16px 0;display:grid;gap:10px;transition:background .3s}
    .trip-row{display:flex;gap:8px;align-items:center;font-size:15px}
    .trip-row .icon{font-size:18px;min-width:24px;text-align:center}
    .trip-row .label{color:#6b7280;min-width:80px}
    .trip-row .value{font-weight:600;color:#1a1a2e;transition:color .3s}
    .section-divider{height:1px;background:#e5e7eb;margin:6px 0;transition:background .3s}
    .section-title{font-size:12px;text-transform:uppercase;letter-spacing:.5px;color:#9ca3af;font-weight:600;margin:4px 0 2px;padding-left:32px}
    .price-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:12px 0}
    .price-card{background:#f0f4f8;border-radius:10px;padding:12px;text-align:center;transition:background .3s}
    .price-card .pc-label{font-size:12px;color:#6b7280;margin-bottom:4px}
    .price-card .pc-value{font-size:20px;font-weight:700;color:#1a1a2e;transition:color .3s}
    .price-card.driver{background:linear-gradient(135deg,#001f3f,#0d6efd);color:#fff}
    .price-card.driver .pc-label{color:rgba(255,255,255,.75)}
    .price-card.driver .pc-value{color:#fff;font-size:26px}
    .price-card.hotel{background:#fef3c7}
    .price-card.hotel .pc-value{color:#92400e}
    .price-card.service{background:#ede9fe}
    .price-card.service .pc-value{color:#5b21b6}
    .name-input{width:100%;padding:12px 16px;border:2px solid #d1d5db;border-radius:10px;font-size:16px;margin:12px 0;outline:none;transition:border-color .2s,background .3s,color .3s;background:#fff;color:#1a1a2e}
    .name-input:focus{border-color:#0d6efd}
    .btn{display:block;width:100%;padding:14px;border:none;border-radius:12px;font-size:17px;font-weight:600;cursor:pointer;transition:all .2s}
    .btn-accept{background:linear-gradient(135deg,#10b981,#059669);color:#fff;margin-top:12px}
    .btn-accept:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(16,185,129,.3)}
    .btn-accept:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
    .btn-complete{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;margin-top:10px;display:none}
    .btn-complete:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(59,130,246,.3)}
    .btn-complete:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
    .btn-completed{background:#dbeafe!important;color:#1e40af!important;cursor:default!important}
    .status{margin-top:16px;padding:12px;border-radius:10px;font-size:14px;display:none}
    .status.ok{display:block;background:#d1fae5;color:#065f46}
    .status.error{display:block;background:#fee2e2;color:#991b1b}
    .status.info{display:block;background:#dbeafe;color:#1e40af}
    .loading{display:none;text-align:center;padding:40px}
    .loading.show{display:block}
    .spinner{width:32px;height:32px;border:3px solid #e5e7eb;border-top-color:#0d6efd;border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 12px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .expired-msg{padding:24px;text-align:center;color:#991b1b}

    /* â”€â”€ dark mode (follows device preference) â”€â”€ */
    @media (prefers-color-scheme: dark) {
      body{background:#0f1923;color:#e0e6ed}
      .card{background:#162432;box-shadow:0 4px 24px rgba(0,0,0,.35)}
      .logo{color:#e0e6ed}
      .trip-info{background:#1b2d3e}
      .trip-row .label{color:#8b9db0}
      .trip-row .value{color:#e0e6ed}
      .section-divider{background:#2d4a5e}
      .section-title{color:#5b7a94}
      .price-card{background:#1b2d3e}
      .price-card .pc-value{color:#e0e6ed}
      .price-card.hotel{background:#422006}
      .price-card.hotel .pc-value{color:#fbbf24}
      .price-card.service{background:#2e1065}
      .price-card.service .pc-value{color:#a78bfa}
      .name-input{background:#1b2d3e;color:#e0e6ed;border-color:#2d4a5e}
      .name-input:focus{border-color:#0d6efd}
      .spinner{border-color:#2d4a5e;border-top-color:#0d6efd}
      .expired-msg{color:#fca5a5}
      .expired-msg p[style]{color:#8b9db0 !important}
      .status.ok{background:#064e3b;color:#6ee7b7}
      .status.error{background:#7f1d1d;color:#fca5a5}
      .status.info{background:#1e3a5f;color:#93c5fd}
      #accepted-content h3{color:#6ee7b7 !important}
      #accepted-content p[style]{color:#8b9db0 !important}
    }
  </style>
</head>
<body>
  <div class="card" id="main-card">
    <div class="logo">Move<span>Athens</span></div>

    <div class="loading show" id="loading">
      <div class="spinner"></div>
      <p>Î¦ÏŒÏÏ„Ï‰ÏƒÎ· ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½ Î´Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚â€¦</p>
    </div>

    <div id="trip-content" style="display:none">
      <h2 style="font-size:18px;margin-bottom:4px">ÎÎ­Î± Î”Î¹Î±Î´ÏÎ¿Î¼Î®</h2>
      <p style="color:#6b7280;font-size:14px;margin-bottom:8px">Î”ÎµÏ‚ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± ÎºÎ±Î¹ Ï€Î¬Ï„Î± Î±Ï€Î¿Î´Î¿Ï‡Î®</p>

      <div class="trip-info" id="trip-details"></div>

      <div class="price-grid" id="price-grid"></div>

      <input type="text" class="name-input" id="driver-name"
        placeholder="Î¤Î¿ ÏŒÎ½Î¿Î¼Î¬ ÏƒÎ¿Ï… (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬)" maxlength="100">

      <button class="btn btn-accept" id="accept-btn">âœ… Î‘Ï€Î¿Î´Î¿Ï‡Î® Î”Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚</button>

      <button class="btn btn-complete" id="complete-btn">ğŸ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Î”Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚</button>

      <div class="status" id="status-msg"></div>
    </div>

    <div id="expired-content" style="display:none">
      <div class="expired-msg">
        <p style="font-size:48px;margin-bottom:12px">â°</p>
        <h3>Î— Î´Î¹Î±Î´ÏÎ¿Î¼Î® Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î·</h3>
        <p style="margin-top:8px;color:#6b7280">ÎœÏ€Î¿ÏÎµÎ¯ Î½Î± Î­Ï‡ÎµÎ¹ Î»Î®Î¾ÎµÎ¹ Î® Î½Î± Î­Ï‡ÎµÎ¹ Î®Î´Î· Î±Ï€Î¿Î´ÎµÏ‡Ï„ÎµÎ¯ ÎºÎ¬Ï€Î¿Î¹Î¿Ï‚ Î¬Î»Î»Î¿Ï‚.</p>
      </div>
    </div>

    <div id="accepted-content" style="display:none">
      <div style="padding:24px;text-align:center">
        <p style="font-size:48px;margin-bottom:12px">ğŸ‰</p>
        <h3 style="color:#065f46">Î— Î´Î¹Î±Î´ÏÎ¿Î¼Î® Î±Ï€Î¿Î´Î­Ï‡Ï„Î·ÎºÎµ!</h3>
        <p style="margin-top:8px;color:#6b7280">ÎšÎ±Î»Î® Î´Î¹Î±Î´ÏÎ¿Î¼Î®! ÎŸ Ï€ÎµÎ»Î¬Ï„Î·Ï‚ Î¸Î± ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯.</p>
      </div>
    </div>
  </div>

  <script>
  (function() {
    'use strict';

    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');

    const loading = document.getElementById('loading');
    const tripContent = document.getElementById('trip-content');
    const expiredContent = document.getElementById('expired-content');
    const acceptedContent = document.getElementById('accepted-content');
    const tripDetails = document.getElementById('trip-details');
    const acceptBtn = document.getElementById('accept-btn');
    const completeBtn = document.getElementById('complete-btn');
    const driverNameInput = document.getElementById('driver-name');
    const statusMsg = document.getElementById('status-msg');

    if (!token) {
      loading.classList.remove('show');
      expiredContent.style.display = 'block';
      return;
    }

    async function loadTrip() {
      try {
        const res = await fetch('/api/moveathens/driver-accept/' + token);
        if (res.status === 404 || res.status === 410) {
          loading.classList.remove('show');
          expiredContent.style.display = 'block';
          return;
        }
        const data = await res.json();
        if (!res.ok) {
          loading.classList.remove('show');
          expiredContent.style.display = 'block';
          return;
        }

        if (data.status === 'completed') {
          renderTrip(data);
          acceptBtn.textContent = 'âœ… Î‘Ï€Î¿Î´ÎµÎºÏ„ÏŒ';
          acceptBtn.disabled = true;
          acceptBtn.style.background = '#d1fae5';
          acceptBtn.style.color = '#065f46';
          driverNameInput.style.display = 'none';
          completeBtn.style.display = 'block';
          completeBtn.textContent = 'ğŸ ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Î·';
          completeBtn.disabled = true;
          completeBtn.classList.add('btn-completed');
          return;
        }

        if (data.status === 'accepted' || data.status === 'confirmed') {
          renderTrip(data);
          acceptBtn.textContent = 'âœ… Î‘Ï€Î¿Î´ÎµÎºÏ„ÏŒ';
          acceptBtn.disabled = true;
          acceptBtn.style.background = '#d1fae5';
          acceptBtn.style.color = '#065f46';
          driverNameInput.style.display = 'none';
          completeBtn.style.display = 'block';
          return;
        }

        renderTrip(data);
      } catch (err) {
        loading.classList.remove('show');
        statusMsg.className = 'status error';
        statusMsg.textContent = 'Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚. Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î¾Î±Î½Î¬.';
      }
    }

    function renderTrip(data) {
      const tariffLabel = data.tariff === 'night' ? 'ğŸŒ™ ÎÏ…Ï‡Ï„ÎµÏÎ¹Î½Î®' : 'â˜€ï¸ Î—Î¼ÎµÏÎ®ÏƒÎ¹Î±';
      let schedule = data.booking_type === 'instant' ? 'âš¡ Î†Î¼ÎµÏƒÎ±' : '';
      if (data.scheduled_date) schedule = 'ğŸ“… ' + data.scheduled_date + (data.scheduled_time ? ' ' + data.scheduled_time : '');

      // â”€â”€ Section: Route â”€â”€
      const sections = [];
      sections.push({ type: 'title', text: 'Î”Î¹Î±Î´ÏÎ¿Î¼Î®' });
      sections.push({ icon: 'ğŸ¯', label: 'Î ÏÎ¿Î¿ÏÎ¹ÏƒÎ¼ÏŒÏ‚', value: data.destination_name || 'â€”' });
      sections.push({ icon: 'ğŸš˜', label: 'ÎŒÏ‡Î·Î¼Î±', value: data.vehicle_name || 'â€”' });
      sections.push({ icon: 'â°', label: 'Î§ÏÏŒÎ½Î¿Ï‚', value: schedule || tariffLabel });
      sections.push({ icon: 'ğŸ’³', label: 'Î Î»Î·ÏÏ‰Î¼Î®', value: data.payment_method === 'pos' ? 'POS' : 'ÎœÎµÏ„ÏÎ·Ï„Î¬' });

      // â”€â”€ Section: Hotel â”€â”€
      sections.push({ type: 'divider' });
      sections.push({ type: 'title', text: 'ÎÎµÎ½Î¿Î´Î¿Ï‡ÎµÎ¯Î¿' });
      sections.push({ icon: 'ğŸ¨', label: 'ÎŒÎ½Î¿Î¼Î±', value: data.hotel_name || 'â€”' });
      if (data.hotel_municipality) {
        sections.push({ icon: 'ğŸ“Œ', label: 'Î”Î®Î¼Î¿Ï‚', value: data.hotel_municipality });
      }
      if (data.hotel_address) {
        sections.push({ icon: 'ğŸ“', label: 'Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·', value: data.hotel_address });
      }

      // â”€â”€ Section: Passengers â”€â”€
      sections.push({ type: 'divider' });
      sections.push({ type: 'title', text: 'Î•Ï€Î¹Î²Î¬Ï„ÎµÏ‚ & Î‘Ï€Î¿ÏƒÎºÎµÏ…Î­Ï‚' });
      if (data.passenger_name) {
        sections.push({ icon: 'ğŸ‘¤', label: 'ÎŒÎ½Î¿Î¼Î±', value: data.passenger_name });
      }
      sections.push({ icon: 'ğŸ‘¥', label: 'Î†Ï„Î¿Î¼Î±', value: data.passengers || 'â€”' });
      const luggageParts = [];
      if (data.luggage_large > 0) luggageParts.push(data.luggage_large + ' Î¼ÎµÎ³Î¬Î».');
      if (data.luggage_medium > 0) luggageParts.push(data.luggage_medium + ' Î¼ÎµÏƒÎ±Î¯.');
      if (data.luggage_cabin > 0) luggageParts.push(data.luggage_cabin + ' Ï‡ÎµÎ¹Ï.');
      sections.push({ icon: 'ğŸ§³', label: 'Î‘Ï€Î¿ÏƒÎºÎµÏ…Î­Ï‚', value: luggageParts.length ? luggageParts.join(', ') : 'â€”' });

      // Render rows
      tripDetails.innerHTML = sections.map(function(r) {
        if (r.type === 'divider') return '<div class="section-divider"></div>';
        if (r.type === 'title') return '<div class="section-title">' + r.text + '</div>';
        return '<div class="trip-row">' +
          '<span class="icon">' + r.icon + '</span>' +
          '<span class="label">' + r.label + '</span>' +
          '<span class="value">' + r.value + '</span>' +
        '</div>';
      }).join('');

      // â”€â”€ Price cards (4 fields) â”€â”€
      var price = parseFloat(data.price || 0);
      var driverCut = parseFloat(data.commission_driver || 0);
      var hotelCut = parseFloat(data.commission_hotel || 0);
      var serviceCut = parseFloat(data.commission_service || 0);

      document.getElementById('price-grid').innerHTML =
        '<div class="price-card driver" style="grid-column:1/-1">' +
          '<div class="pc-label">ğŸ’¶ Î— Î±Î¼Î¿Î¹Î²Î® ÏƒÎ¿Ï…</div>' +
          '<div class="pc-value">â‚¬' + driverCut.toFixed(0) + '</div>' +
        '</div>' +
        '<div class="price-card">' +
          '<div class="pc-label">ğŸ’° Î£Ï…Î½Î¿Î». Î§ÏÎ­Ï‰ÏƒÎ·</div>' +
          '<div class="pc-value">â‚¬' + price.toFixed(0) + '</div>' +
        '</div>' +
        '<div class="price-card hotel">' +
          '<div class="pc-label">ğŸ¨ ÎÎµÎ½Î¿Î´ÏŒÏ‡Î¿Ï‚</div>' +
          '<div class="pc-value">â‚¬' + hotelCut.toFixed(0) + '</div>' +
        '</div>' +
        '<div class="price-card service">' +
          '<div class="pc-label">ğŸ”§ Î¥Ï€Î·ÏÎµÏƒÎ¯Î±</div>' +
          '<div class="pc-value">â‚¬' + serviceCut.toFixed(0) + '</div>' +
        '</div>';

      loading.classList.remove('show');
      tripContent.style.display = 'block';
    }

    acceptBtn.addEventListener('click', async function() {
      acceptBtn.disabled = true;
      acceptBtn.textContent = 'Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®â€¦';
      statusMsg.className = 'status';
      statusMsg.textContent = '';

      try {
        const res = await fetch('/api/moveathens/driver-accept/' + token, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ driver_name: driverNameInput.value.trim() })
        });
        const data = await res.json();

        if (res.ok && (data.ok || data.already)) {
          acceptBtn.textContent = 'âœ… Î‘Ï€Î¿Î´ÎµÎºÏ„ÏŒ';
          acceptBtn.disabled = true;
          acceptBtn.style.background = '#d1fae5';
          acceptBtn.style.color = '#065f46';
          driverNameInput.style.display = 'none';
          completeBtn.style.display = 'block';
          statusMsg.className = 'status ok';
          statusMsg.textContent = 'ÎšÎ±Î»Î® Î´Î¹Î±Î´ÏÎ¿Î¼Î®! ÎŸ Ï€ÎµÎ»Î¬Ï„Î·Ï‚ Î¸Î± ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯.';
        } else {
          statusMsg.className = 'status error';
          statusMsg.textContent = data.error || 'Î£Ï†Î¬Î»Î¼Î±. Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î¾Î±Î½Î¬.';
          acceptBtn.disabled = false;
          acceptBtn.textContent = 'âœ… Î‘Ï€Î¿Î´Î¿Ï‡Î® Î”Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚';
        }
      } catch (err) {
        statusMsg.className = 'status error';
        statusMsg.textContent = 'Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚.';
        acceptBtn.disabled = false;
        acceptBtn.textContent = 'âœ… Î‘Ï€Î¿Î´Î¿Ï‡Î® Î”Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚';
      }
    });

    completeBtn.addEventListener('click', async function() {
      completeBtn.disabled = true;
      completeBtn.textContent = 'Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®â€¦';

      try {
        const res = await fetch('/api/moveathens/driver-complete/' + token, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();

        if (res.ok && data.ok) {
          completeBtn.textContent = 'ğŸ ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Î·';
          completeBtn.disabled = true;
          completeBtn.classList.add('btn-completed');
          statusMsg.className = 'status ok';
          statusMsg.textContent = 'Î— Î´Î¹Î±Î´ÏÎ¿Î¼Î® Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ. Î•Ï…Ï‡Î±ÏÎ¹ÏƒÏ„Î¿ÏÎ¼Îµ!';
        } else {
          statusMsg.className = 'status error';
          statusMsg.textContent = data.error || 'Î£Ï†Î¬Î»Î¼Î±. Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î¾Î±Î½Î¬.';
          completeBtn.disabled = false;
          completeBtn.textContent = 'ğŸ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Î”Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚';
        }
      } catch (err) {
        statusMsg.className = 'status error';
        statusMsg.textContent = 'Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚.';
        completeBtn.disabled = false;
        completeBtn.textContent = 'ğŸ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Î”Î¹Î±Î´ÏÎ¿Î¼Î®Ï‚';
      }
    });

    loadTrip();
  })();
  </script>
</body>
</html>
